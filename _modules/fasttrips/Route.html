

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>fasttrips.Route &mdash; fasttrips Development Branch Commit 5e504cb3319b58faac3aca1310cb4ad08dc44ed8 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> fasttrips
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howitworks.html">How Fast-Trips Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io.html">Input/Output Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Using Fast-Trips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Fast-Trips Classes and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fasttrips</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>fasttrips.Route</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fasttrips.Route</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">object</span>

<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2015 Contributing Entities&quot;</span>
<span class="n">__license__</span>   <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s2">    you may not use this file except in compliance with the License.</span>
<span class="s2">    You may obtain a copy of the License at</span>

<span class="s2">        http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="s2">    Unless required by applicable law or agreed to in writing, software</span>
<span class="s2">    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s2">    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s2">    See the License for the specific language governing permissions and</span>
<span class="s2">    limitations under the License.</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">.Error</span>  <span class="kn">import</span> <span class="n">NetworkInputError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">,</span> <span class="n">UnexpectedError</span>
<span class="kn">from</span> <span class="nn">.Logger</span> <span class="kn">import</span> <span class="n">FastTripsLogger</span>
<span class="kn">from</span> <span class="nn">.Util</span>   <span class="kn">import</span> <span class="n">Util</span>


<div class="viewcode-block" id="Route"><a class="viewcode-back" href="../../_generated/fasttrips.Route.html#fasttrips.Route">[docs]</a><span class="k">class</span> <span class="nc">Route</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Route class.</span>

<span class="sd">    One instance represents all of the Routes.</span>

<span class="sd">    Stores route information in :py:attr:`Route.routes_df` and agency information in</span>
<span class="sd">    :py:attr:`Route.agencies_df`. Each are instances of :py:class:`pandas.DataFrame`.</span>

<span class="sd">    Fare information is in :py:attr:`Route.fare_attrs_df`, :py:attr:`Route.fare_rules_df` and</span>
<span class="sd">    :py:attr:`Route.fare_transfer_rules_df`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: File with fasttrips routes information (this extends the</span>
    <span class="c1">#: `gtfs routes &lt;https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/routes.md&gt;`_ file).</span>
    <span class="c1">#: See `routes_ft specification &lt;https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/routes_ft.md&gt;`_.</span>
    <span class="n">INPUT_ROUTES_FILE</span>                       <span class="o">=</span> <span class="s2">&quot;routes_ft.txt&quot;</span>
    <span class="c1">#: gtfs Routes column name: Unique identifier</span>
    <span class="n">ROUTES_COLUMN_ROUTE_ID</span>                  <span class="o">=</span> <span class="s2">&quot;route_id&quot;</span>
    <span class="c1">#: gtfs Routes column name: Short name</span>
    <span class="n">ROUTES_COLUMN_ROUTE_SHORT_NAME</span>          <span class="o">=</span> <span class="s2">&quot;route_short_name&quot;</span>
    <span class="c1">#: gtfs Routes column name: Long name</span>
    <span class="n">ROUTES_COLUMN_ROUTE_LONG_NAME</span>           <span class="o">=</span> <span class="s2">&quot;route_long_name&quot;</span>
    <span class="c1">#: gtfs Routes column name: Route type</span>
    <span class="n">ROUTES_COLUMN_ROUTE_TYPE</span>                <span class="o">=</span> <span class="s2">&quot;route_type&quot;</span>
    <span class="c1">#: gtfs Routes column name: Agency ID</span>
    <span class="n">ROUTES_COLUMN_AGENCY_ID</span>                 <span class="o">=</span> <span class="s2">&quot;agency_id&quot;</span>
    <span class="c1">#: fasttrips Routes column name: Mode</span>
    <span class="n">ROUTES_COLUMN_MODE</span>                      <span class="o">=</span> <span class="s2">&quot;mode&quot;</span>
    <span class="c1">#: fasttrips Routes column name: Proof of Payment</span>
    <span class="n">ROUTES_COLUMN_PROOF_OF_PAYMENT</span>          <span class="o">=</span> <span class="s2">&quot;proof_of_payment&quot;</span>

    <span class="c1"># ========== Added by fasttrips =======================================================</span>
    <span class="c1">#: fasttrips Routes column name: Mode number</span>
    <span class="n">ROUTES_COLUMN_ROUTE_ID_NUM</span>              <span class="o">=</span> <span class="s2">&quot;route_id_num&quot;</span>
    <span class="c1">#: fasttrips Routes column name: Mode number</span>
    <span class="n">ROUTES_COLUMN_MODE_NUM</span>                  <span class="o">=</span> <span class="s2">&quot;mode_num&quot;</span>
    <span class="c1">#: fasttrips Routes column name: Mode type</span>
    <span class="n">ROUTES_COLUMN_MODE_TYPE</span>                 <span class="o">=</span> <span class="s2">&quot;mode_type&quot;</span>
    <span class="c1">#: Value for :py:attr:`Route.ROUTES_COLUMN_MODE_TYPE` column: access</span>
    <span class="n">MODE_TYPE_ACCESS</span>                        <span class="o">=</span> <span class="s2">&quot;access&quot;</span>
    <span class="c1">#: Value for :py:attr:`Route.ROUTES_COLUMN_MODE_TYPE` column: egress</span>
    <span class="n">MODE_TYPE_EGRESS</span>                        <span class="o">=</span> <span class="s2">&quot;egress&quot;</span>
    <span class="c1">#: Value for :py:attr:`Route.ROUTES_COLUMN_MODE_TYPE` column: transit</span>
    <span class="n">MODE_TYPE_TRANSIT</span>                       <span class="o">=</span> <span class="s2">&quot;transit&quot;</span>
    <span class="c1">#: Value for :py:attr:`Route.ROUTES_COLUMN_MODE_TYPE` column: transfer</span>
    <span class="n">MODE_TYPE_TRANSFER</span>                      <span class="o">=</span> <span class="s2">&quot;transfer&quot;</span>
    <span class="c1">#: Access mode numbers start from here</span>
    <span class="n">MODE_NUM_START_ACCESS</span>                   <span class="o">=</span> <span class="mi">101</span>
    <span class="c1">#: Egress mode numbers start from here</span>
    <span class="n">MODE_NUM_START_EGRESS</span>                   <span class="o">=</span> <span class="mi">201</span>
    <span class="c1">#: Route mode numbers start from here</span>
    <span class="n">MODE_NUM_START_ROUTE</span>                    <span class="o">=</span> <span class="mi">301</span>

    <span class="c1">#: File with fasttrips fare attributes information (this *subsitutes rather than extends* the</span>
    <span class="c1">#: `gtfs fare_attributes &lt;https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/fare_attributes_ft.md&gt;`_ file).</span>
    <span class="c1">#: See `fare_attributes_ft specification &lt;https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/fare_attributes_ft.md&gt;`_.</span>
    <span class="n">INPUT_FARE_ATTRIBUTES_FILE</span>              <span class="o">=</span> <span class="s2">&quot;fare_attributes_ft.txt&quot;</span>
    <span class="c1"># fasttrips Fare attributes column name: Fare Period</span>
    <span class="n">FARE_ATTR_COLUMN_FARE_PERIOD</span>            <span class="o">=</span> <span class="s2">&quot;fare_period&quot;</span>
    <span class="c1"># fasttrips Fare attributes column name: Price</span>
    <span class="n">FARE_ATTR_COLUMN_PRICE</span>                  <span class="o">=</span> <span class="s2">&quot;price&quot;</span>
    <span class="c1"># fasttrips Fare attributes column name: Currency Type</span>
    <span class="n">FARE_ATTR_COLUMN_CURRENCY_TYPE</span>          <span class="o">=</span> <span class="s2">&quot;currency_type&quot;</span>
    <span class="c1"># fasttrips Fare attributes column name: Payment Method</span>
    <span class="n">FARE_ATTR_COLUMN_PAYMENT_METHOD</span>         <span class="o">=</span> <span class="s2">&quot;payment_method&quot;</span>
    <span class="c1"># fasttrips Fare attributes column name: Transfers (number permitted on this fare)</span>
    <span class="n">FARE_ATTR_COLUMN_TRANSFERS</span>              <span class="o">=</span> <span class="s2">&quot;transfers&quot;</span>
    <span class="c1"># fasttrips Fare attributes column name: Transfer duration (Integer length of time in seconds before transfer expires. Omit or leave empty if they do not.)</span>
    <span class="n">FARE_ATTR_COLUMN_TRANSFER_DURATION</span>      <span class="o">=</span> <span class="s2">&quot;transfer_duration&quot;</span>

    <span class="c1">#: File with fasttrips fare periods information</span>
    <span class="c1">#: See `fare_rules_ft specification &lt;https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/fare_rules_ft.md&gt;`_.</span>
    <span class="n">INPUT_FARE_PERIODS_FILE</span>                 <span class="o">=</span> <span class="s2">&quot;fare_periods_ft.txt&quot;</span>
    <span class="c1">#: fasttrips Fare rules column name: Fare ID</span>
    <span class="n">FARE_RULES_COLUMN_FARE_ID</span>               <span class="o">=</span> <span class="s2">&quot;fare_id&quot;</span>
    <span class="c1">#: GTFS fare rules column name: Route ID</span>
    <span class="n">FARE_RULES_COLUMN_ROUTE_ID</span>              <span class="o">=</span> <span class="n">ROUTES_COLUMN_ROUTE_ID</span>
    <span class="c1">#: GTFS fare rules column name: Origin Zone ID</span>
    <span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span>             <span class="o">=</span> <span class="s2">&quot;origin_id&quot;</span>
    <span class="c1">#: GTFS fare rules column name: Destination Zone ID</span>
    <span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span>        <span class="o">=</span> <span class="s2">&quot;destination_id&quot;</span>
    <span class="c1">#: GTFS fare rules column name: Contains ID</span>
    <span class="n">FARE_RULES_COLUMN_CONTAINS_ID</span>           <span class="o">=</span> <span class="s2">&quot;contains_id&quot;</span>
    <span class="c1">#: fasttrips Fare rules column name: Fare class</span>
    <span class="n">FARE_RULES_COLUMN_FARE_PERIOD</span>           <span class="o">=</span> <span class="n">FARE_ATTR_COLUMN_FARE_PERIOD</span>
    <span class="c1">#: fasttrips Fare rules column name: Start time for the fare. A DateTime</span>
    <span class="n">FARE_RULES_COLUMN_START_TIME</span>            <span class="o">=</span> <span class="s2">&quot;start_time&quot;</span>
    <span class="c1">#: fasttrips Fare rules column name: End time for the fare rule. A DateTime.</span>
    <span class="n">FARE_RULES_COLUMN_END_TIME</span>              <span class="o">=</span> <span class="s2">&quot;end_time&quot;</span>

    <span class="c1"># ========== Added by fasttrips =======================================================</span>
    <span class="c1">#: fasttrips Fare rules column name: Fare ID num</span>
    <span class="n">FARE_RULES_COLUMN_FARE_ID_NUM</span>           <span class="o">=</span> <span class="s2">&quot;fare_id_num&quot;</span>
    <span class="c1">#: fasttrips Fare rules column name: Route ID num</span>
    <span class="n">FARE_RULES_COLUMN_ROUTE_ID_NUM</span>           <span class="o">=</span> <span class="n">ROUTES_COLUMN_ROUTE_ID_NUM</span>
    <span class="c1">#: fasttrips fare rules column name: Origin Zone ID number</span>
    <span class="n">FARE_RULES_COLUMN_ORIGIN_ID_NUM</span>         <span class="o">=</span> <span class="s2">&quot;origin_id_num&quot;</span>
    <span class="c1">#: fasttrips fare rules column name: Destination ID number</span>
    <span class="n">FARE_RULES_COLUMN_DESTINATION_ID_NUM</span>    <span class="o">=</span> <span class="s2">&quot;destination_id_num&quot;</span>

    <span class="c1">#: File with fasttrips fare transfer rules information.</span>
    <span class="c1">#: See `fare_transfer_rules specification &lt;https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/fare_transfer_rules_ft.md&gt;`_.</span>
    <span class="n">INPUT_FARE_TRANSFER_RULES_FILE</span>              <span class="o">=</span> <span class="s2">&quot;fare_transfer_rules_ft.txt&quot;</span>
    <span class="c1">#: fasttrips Fare transfer rules column name: From Fare Class</span>
    <span class="n">FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD</span> <span class="o">=</span> <span class="s2">&quot;from_fare_period&quot;</span>
    <span class="c1">#: fasttrips Fare transfer rules column name: To Fare Class</span>
    <span class="n">FARE_TRANSFER_RULES_COLUMN_TO_FARE_PERIOD</span>   <span class="o">=</span> <span class="s2">&quot;to_fare_period&quot;</span>
    <span class="c1">#: fasttrips Fare transfer rules column name: Transfer type?</span>
    <span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span>             <span class="o">=</span> <span class="s2">&quot;transfer_fare_type&quot;</span>
    <span class="c1">#: fasttrips Fare transfer rules column name: Transfer amount (discount or fare)</span>
    <span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span>           <span class="o">=</span> <span class="s2">&quot;transfer_fare&quot;</span>

    <span class="c1">#: Value for :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_TYPE`: transfer discount</span>
    <span class="n">TRANSFER_TYPE_TRANSFER_DISCOUNT</span> <span class="o">=</span> <span class="s2">&quot;transfer_discount&quot;</span>
    <span class="c1">#: Value for :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_TYPE`: free transfer</span>
    <span class="n">TRANSFER_TYPE_TRANSFER_FREE</span>     <span class="o">=</span> <span class="s2">&quot;transfer_free&quot;</span>
    <span class="c1">#: Value for :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_TYPE`: transfer fare cost</span>
    <span class="n">TRANSFER_TYPE_TRANSFER_COST</span>     <span class="o">=</span> <span class="s2">&quot;transfer_cost&quot;</span>

    <span class="c1">#: Valid options for :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_TYPE`</span>
    <span class="n">TRANSFER_TYPE_OPTIONS</span> <span class="o">=</span> <span class="p">[</span><span class="n">TRANSFER_TYPE_TRANSFER_DISCOUNT</span><span class="p">,</span>
                             <span class="n">TRANSFER_TYPE_TRANSFER_FREE</span><span class="p">,</span>
                             <span class="n">TRANSFER_TYPE_TRANSFER_COST</span><span class="p">]</span>

    <span class="c1">#: File with route ID, route ID number correspondence (and fare id num)</span>
    <span class="n">OUTPUT_ROUTE_ID_NUM_FILE</span>                    <span class="o">=</span> <span class="s2">&quot;ft_intermediate_route_id.txt&quot;</span>
    <span class="c1">#: File with fare id num, fare id, fare class, price, xfers</span>
    <span class="n">OUTPUT_FARE_ID_FILE</span>                         <span class="o">=</span> <span class="s2">&quot;ft_intermediate_fare.txt&quot;</span>
    <span class="c1">#: File with fare transfer rules</span>
    <span class="n">OUTPUT_FARE_TRANSFER_FILE</span>                   <span class="o">=</span> <span class="s2">&quot;ft_intermediate_fare_transfers.txt&quot;</span>
    <span class="c1">#: File with mode, mode number correspondence</span>
    <span class="n">OUTPUT_MODE_NUM_FILE</span>                        <span class="o">=</span> <span class="s2">&quot;ft_intermediate_supply_mode_id.txt&quot;</span>

<div class="viewcode-block" id="Route.__init__"><a class="viewcode-back" href="../../_generated/fasttrips.Route.html#fasttrips.Route.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_archive</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">gtfs</span><span class="p">,</span> <span class="n">today</span><span class="p">,</span> <span class="n">stops</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor.  Reads the gtfs data from the transitfeed schedule, and the additional</span>
<span class="sd">        fast-trips routes data from the input file in *input_archive*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>         <span class="o">=</span> <span class="n">output_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span> <span class="o">=</span> <span class="n">gtfs</span><span class="o">.</span><span class="n">routes</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%7d</span><span class="s2"> </span><span class="si">%15s</span><span class="s2"> from </span><span class="si">%25d</span><span class="s2"> </span><span class="si">%25s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span><span class="p">),</span> <span class="s1">&#39;date valid route&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gtfs</span><span class="o">.</span><span class="n">routes</span><span class="p">),</span> <span class="s1">&#39;total routes&#39;</span><span class="p">))</span>

        <span class="c1"># Read the fast-trips supplemental routes data file</span>
        <span class="n">routes_ft_df</span> <span class="o">=</span> <span class="n">gtfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">INPUT_ROUTES_FILE</span><span class="p">)</span>

        <span class="c1"># verify required columns are present</span>
        <span class="n">routes_ft_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">routes_ft_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span>     <span class="ow">in</span> <span class="n">routes_ft_cols</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE</span>         <span class="ow">in</span> <span class="n">routes_ft_cols</span><span class="p">)</span>

        <span class="c1"># verify no routes_ids are duplicated</span>
        <span class="k">if</span> <span class="n">routes_ft_df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> duplicate </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">routes_ft_df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                                                         <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">INPUT_ROUTES_FILE</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Duplicates:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                  <span class="nb">str</span><span class="p">(</span><span class="n">routes_ft_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">routes_ft_df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">])]))</span>
            <span class="k">raise</span> <span class="n">NetworkInputError</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">INPUT_ROUTES_FILE</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>

        <span class="c1"># Join to the routes dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">routes_ft_df</span><span class="p">,</span>
                                      <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                      <span class="n">on</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">)</span>
        <span class="c1"># Get the mode list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span><span class="p">[[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="n">Route</span><span class="o">.</span><span class="n">MODE_NUM_START_ROUTE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">Route</span><span class="o">.</span><span class="n">MODE_TYPE_TRANSIT</span>

        <span class="c1"># Join to mode numbering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="n">add_new_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_NUM</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span><span class="p">,</span>  <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_NUM</span><span class="p">)</span>

        <span class="c1"># Route IDs are strings.  Create a unique numeric route ID.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">route_id_df</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="n">add_numeric_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span><span class="p">[[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">]],</span>
                                                   <span class="n">id_colname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">,</span>
                                                   <span class="n">numeric_newcolname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID_NUM</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Route ID to number correspondence</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">route_id_df</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">route_id_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_numeric_route_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span><span class="p">,</span>
                                                   <span class="n">id_colname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">,</span>
                                                   <span class="n">numeric_newcolname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID_NUM</span><span class="p">)</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=========== ROUTES ===========</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%7d</span><span class="s2"> </span><span class="si">%15s</span><span class="s2"> from </span><span class="si">%25s</span><span class="s2">, </span><span class="si">%25s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routes_df</span><span class="p">),</span> <span class="s2">&quot;routes&quot;</span><span class="p">,</span> <span class="s2">&quot;routes.txt&quot;</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">INPUT_ROUTES_FILE</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">agencies_df</span> <span class="o">=</span> <span class="n">gtfs</span><span class="o">.</span><span class="n">agency</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=========== AGENCIES ===========</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agencies_df</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agencies_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%7d</span><span class="s2"> </span><span class="si">%15s</span><span class="s2"> from </span><span class="si">%25s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agencies_df</span><span class="p">),</span> <span class="s2">&quot;agencies&quot;</span><span class="p">,</span> <span class="s2">&quot;agency.txt&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span> <span class="o">=</span> <span class="n">gtfs</span><span class="o">.</span><span class="n">fare_attributes</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=========== FARE ATTRIBUTES ===========</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%7d</span><span class="s2"> </span><span class="si">%15s</span><span class="s2"> from </span><span class="si">%25s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="p">),</span> <span class="s2">&quot;fare attributes&quot;</span><span class="p">,</span> <span class="s2">&quot;fare_attributes.txt&quot;</span><span class="p">))</span>

        <span class="c1"># subsitute fasttrips fare attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span> <span class="o">=</span> <span class="n">gtfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">INPUT_FARE_ATTRIBUTES_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># verify required columns are present</span>
            <span class="n">fare_attrs_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_FARE_PERIOD</span>       <span class="ow">in</span> <span class="n">fare_attrs_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_PRICE</span>             <span class="ow">in</span> <span class="n">fare_attrs_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_CURRENCY_TYPE</span>     <span class="ow">in</span> <span class="n">fare_attrs_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_PAYMENT_METHOD</span>    <span class="ow">in</span> <span class="n">fare_attrs_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFERS</span>         <span class="ow">in</span> <span class="n">fare_attrs_cols</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFER_DURATION</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fare_attrs_cols</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFER_DURATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;===&gt; REPLACED BY FARE ATTRIBUTES FT</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%7d</span><span class="s2"> </span><span class="si">%15s</span><span class="s2"> from </span><span class="si">%25s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="p">),</span> <span class="s2">&quot;fare attributes&quot;</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">INPUT_FARE_ATTRIBUTES_FILE</span><span class="p">))</span>

            <span class="c1">#: fares are by fare_period rather than by fare_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_by_class</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_by_class</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Fare rules (map routes to fare_id)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span> <span class="o">=</span> <span class="n">gtfs</span><span class="o">.</span><span class="n">fare_rules</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_ids_df</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="n">add_numeric_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">]],</span>
                                                       <span class="n">id_colname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">,</span>
                                                       <span class="n">numeric_newcolname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID_NUM</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>  <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">,</span>
                                              <span class="n">right</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_ids_df</span><span class="p">,</span>
                                              <span class="n">how</span>   <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_ids_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>


        <span class="c1"># optionally reverse those with origin/destinations if configured</span>
        <span class="kn">from</span> <span class="nn">.Assignment</span> <span class="kn">import</span> <span class="n">Assignment</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">FARE_ZONE_SYMMETRY</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;applying FARE_ZONE_SYMMETRY to </span><span class="si">%d</span><span class="s2"> fare rules&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">))</span>
            <span class="c1"># select only those with an origin and destination</span>
            <span class="n">reverse_fare_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span><span class="p">])</span><span class="o">&amp;</span>
                                                         <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">])</span> <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># FastTripsLogger.debug(&quot;reverse_fare_rules 1 head()=\n%s&quot; % str(reverse_fare_rules.head()))</span>

            <span class="c1"># reverse them</span>
            <span class="n">reverse_fare_rules</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span>          <span class="p">:</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">,</span>
                                               <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span>     <span class="p">:</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span><span class="p">},</span>
                                      <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># FastTripsLogger.debug(&quot;reverse_fare_rules 2 head()=\n%s&quot; % str(reverse_fare_rules.head()))</span>

            <span class="c1"># join them to eliminate dupes</span>
            <span class="n">reverse_fare_rules</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">reverse_fare_rules</span><span class="p">,</span>
                                              <span class="n">right</span>    <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">,</span>
                                              <span class="n">how</span>      <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                              <span class="n">on</span>       <span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">,</span>
                                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID_NUM</span><span class="p">,</span>
                                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span><span class="p">,</span>
                                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span><span class="p">,</span>
                                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">,</span>
                                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_CONTAINS_ID</span><span class="p">],</span>
                                              <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># dupes exist in both -- drop those</span>
            <span class="n">reverse_fare_rules</span> <span class="o">=</span> <span class="n">reverse_fare_rules</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">reverse_fare_rules</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;left_only&quot;</span><span class="p">]</span>
            <span class="n">reverse_fare_rules</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># add them to fare rules</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">,</span> <span class="n">reverse_fare_rules</span><span class="p">])</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;fare rules with symmetry </span><span class="si">%d</span><span class="s2"> head()=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">head</span><span class="p">())))</span>

        <span class="c1"># sort by fare ID num so zone-to-zone and their reverse are together</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID_NUM</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fare_rules_ft_df</span> <span class="o">=</span> <span class="n">gtfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">INPUT_FARE_PERIODS_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fare_rules_ft_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># verify required columns are present</span>
            <span class="n">fare_rules_ft_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fare_rules_ft_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span>      <span class="ow">in</span> <span class="n">fare_rules_ft_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_PERIOD</span>  <span class="ow">in</span> <span class="n">fare_rules_ft_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span>   <span class="ow">in</span> <span class="n">fare_rules_ft_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span>     <span class="ow">in</span> <span class="n">fare_rules_ft_cols</span><span class="p">)</span>

            <span class="c1"># Split fare classes so they don&#39;t overlap</span>
            <span class="n">fare_rules_ft_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_fare_period_overlap</span><span class="p">(</span><span class="n">fare_rules_ft_df</span><span class="p">)</span>

            <span class="c1"># join to fare rules dataframe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">fare_rules_ft_df</span><span class="p">,</span>
                                              <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                              <span class="n">on</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">)</span>

            <span class="c1"># add route id numbering if applicable</span>
            <span class="k">if</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_numeric_route_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">,</span>
                                                               <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span><span class="p">,</span>
                                                               <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID_NUM</span><span class="p">)</span>
            <span class="c1"># add origin zone numbering if applicable</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="ow">and</span> \
               <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span> <span class="o">=</span> <span class="n">stops</span><span class="o">.</span><span class="n">add_numeric_stop_zone_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">,</span>
                                                                    <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span><span class="p">,</span>
                                                                    <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID_NUM</span><span class="p">)</span>
            <span class="c1"># add destination zone numbering if applicable</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span> <span class="o">=</span> <span class="n">stops</span><span class="o">.</span><span class="n">add_numeric_stop_zone_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">,</span>
                                                                    <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">,</span>
                                                                    <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID_NUM</span><span class="p">)</span>
                <span class="c1"># They should both be present</span>
                <span class="c1"># This is unlikely</span>
                <span class="k">if</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                    <span class="n">error_str</span> <span class="o">=</span> <span class="s2">&quot;Fast-trips only supports both origin_id and destination_id or neither in fare rules&quot;</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>

                <span class="c1"># check for each row, either both are present or neither -- use xor, or ^</span>
                <span class="n">xor_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span><span class="p">])</span><span class="o">^</span>
                                                 <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">])</span> <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xor_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">error_str</span> <span class="o">=</span> <span class="s2">&quot;Fast-trips supports fare rules with both origin id and destination id specified, or neither ONLY.</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">xor_id</span><span class="p">)</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>

            <span class="c1"># We don&#39;t support contains_id</span>
            <span class="k">if</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_CONTAINS_ID</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="n">non_null_contains_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_CONTAINS_ID</span><span class="p">])]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_null_contains_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">error_str</span> <span class="o">=</span> <span class="s2">&quot;Fast-trips does not support contains_id in fare rules:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">non_null_contains_id</span><span class="p">)</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>

            <span class="c1"># We don&#39;t support rows with only one of origin_id or destination_id specified</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># we have fare rules but no fare periods -- make the fare periods the same</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="n">read_time</span><span class="p">(</span><span class="s2">&quot;00:00:00&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="n">read_time</span><span class="p">(</span><span class="s2">&quot;24:00:00&quot;</span><span class="p">)</span>

        <span class="c1"># join to fare_attributes on fare_period if we have it, or fare_id if we don&#39;t</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Fare ID/class (fare period)/attribute mapping.</span>

<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            | *Column name*         | Column Description                                                                                                                   |</span>
<span class="sd">            +=======================+======================================================================================================================================+</span>
<span class="sd">            |``fare_id``            |GTFS fare_id (See `fare_rules`_)                                                                                                      |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``fare_id_num``        |Numbered fare_id                                                                                                                      |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``route_id``           |(optional) Route(s) associated with this fare ID. (See `fare_rules`_)                                                                 |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``origin_id``          |(optional) Origin fare zone ID(s) for fare ID. (See `fare_rules`_)                                                                    |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``origin_id_num``      |(optional) Origin fare zone number for fare ID.                                                                                       |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``destination_id``     |(optional) Destination fare zone ID(s) for fare ID. (See `fare_rules`_)                                                               |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``destination_id_num`` |(optional) Destination fare zone number for fare ID.                                                                                  |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``contains_id``        |(optional) Contains fare zone ID(s) for fare ID. (See `fare_rules`_)                                                                  |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``fare_period``        |GTFS-plus fare_period (See `fare_periods_ft`_)                                                                                        |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``start_time``         |Fare class start time (See `fare_rules_ft`_)                                                                                          |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``end_time``           |Fare class end time (See `fare_rules_ft`_)                                                                                            |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``currency_type``      |Currency of fare class or id (See `fare_attributes`_ or `fare_attributes_ft`_)                                                        |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``price``              |Price of fare class or id (See `fare_attributes`_ or `fare_attributes_ft`_)                                                           |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``payment_method``     |When the fare must be paid (See `fare_attributes`_ or `fare_attributes_ft`_)                                                          |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``transfers``          |Number of transfers permiited on this fare (See `fare_attributes`_ or `fare_attributes_ft`_)                                          |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">            |``transfer_duration``  |(optional) Integer length of time in seconds before transfer expires (See `fare_attributes`_ or `fare_attributes_ft`_)                |</span>
<span class="sd">            +-----------------------+--------------------------------------------------------------------------------------------------------------------------------------+</span>

<span class="sd">            .. _fare_rules: https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/fare_rules.md</span>
<span class="sd">            .. _fare_rules_ft: https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/fare_rules_ft.md</span>
<span class="sd">            .. _fare_attributes: https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/fare_attributes.md</span>
<span class="sd">            .. _fare_attributes_ft: https://github.com/osplanning-data-standards/GTFS-PLUS/blob/master/files/fare_attributes_ft.md</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">,</span>
                                              <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_attrs_df</span><span class="p">,</span>
                                              <span class="n">how</span>  <span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                              <span class="n">on</span>   <span class="o">=</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_PERIOD</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_by_class</span> <span class="k">else</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">)</span>


        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=========== FARE RULES ===========</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                              <span class="p">{</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">:</span><span class="n">Util</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
                               <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span>  <span class="p">:</span><span class="n">Util</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">})))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%7d</span><span class="s2"> </span><span class="si">%15s</span><span class="s2"> from </span><span class="si">%25s</span><span class="s2">, </span><span class="si">%25s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">),</span> <span class="s2">&quot;fare rules&quot;</span><span class="p">,</span> <span class="s2">&quot;fare_rules.txt&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">INPUT_FARE_PERIODS_FILE</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span> <span class="o">=</span> <span class="n">gtfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">INPUT_FARE_TRANSFER_RULES_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># verify required columns are present</span>
            <span class="n">fare_transfer_rules_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD</span> <span class="ow">in</span> <span class="n">fare_transfer_rules_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TO_FARE_PERIOD</span>   <span class="ow">in</span> <span class="n">fare_transfer_rules_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span>             <span class="ow">in</span> <span class="n">fare_transfer_rules_cols</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span>           <span class="ow">in</span> <span class="n">fare_transfer_rules_cols</span><span class="p">)</span>

            <span class="c1"># verify valid values for transfer type</span>
            <span class="n">invalid_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">TRANSFER_TYPE_OPTIONS</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span> <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid value for </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">invalid_type</span><span class="p">))</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">NetworkInputError</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">INPUT_FARE_TRANSFER_RULES_FILE</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>

            <span class="c1"># verify the amount is positive</span>
            <span class="n">negative_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_amount</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Negative transfer amounts are invalid:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">negative_amount</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">NetworkInputError</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">INPUT_FARE_TRANSFER_RULES_FILE</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=========== FARE TRANSFER RULES ===========</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%7d</span><span class="s2"> </span><span class="si">%15s</span><span class="s2"> from </span><span class="si">%25s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="p">),</span> <span class="s2">&quot;fare xfer rules&quot;</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">INPUT_FARE_TRANSFER_RULES_FILE</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_routes_for_extension</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">add_numeric_route_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_df</span><span class="p">,</span> <span class="n">id_colname</span><span class="p">,</span> <span class="n">numeric_newcolname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Passing a :py:class:`pandas.DataFrame` with a route ID column called *id_colname*,</span>
<span class="sd">        adds the numeric route id as a column named *numeric_newcolname* and returns it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Util</span><span class="o">.</span><span class="n">add_new_id</span><span class="p">(</span><span class="n">input_df</span><span class="p">,</span> <span class="n">id_colname</span><span class="p">,</span> <span class="n">numeric_newcolname</span><span class="p">,</span>
                               <span class="n">mapping_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">route_id_df</span><span class="p">,</span>
                               <span class="n">mapping_id_colname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">,</span>
                               <span class="n">mapping_newid_colname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID_NUM</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_access_egress_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_modes_df</span><span class="p">,</span> <span class="n">egress_modes_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds access and egress modes to the mode list</span>
<span class="sd">        Writes out mapping to disk</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">access_modes_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">Route</span><span class="o">.</span><span class="n">MODE_TYPE_ACCESS</span>
        <span class="n">egress_modes_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">Route</span><span class="o">.</span><span class="n">MODE_TYPE_EGRESS</span>
        <span class="n">implicit_modes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_TYPE</span><span class="p">:</span> <span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">MODE_TYPE_TRANSFER</span><span class="p">],</span>
                                              <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE</span><span class="p">:</span>      <span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">MODE_TYPE_TRANSFER</span><span class="p">],</span>
                                              <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_NUM</span><span class="p">:</span>  <span class="p">[</span>                       <span class="mi">1</span><span class="p">]})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">implicit_modes_df</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span><span class="p">,</span>
                                      <span class="n">access_modes_df</span><span class="p">,</span>
                                      <span class="n">egress_modes_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># write intermediate files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">OUTPUT_MODE_NUM_FILE</span><span class="p">),</span>
                             <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_NUM</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE</span><span class="p">],</span>
                             <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">OUTPUT_MODE_NUM_FILE</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_numeric_mode_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_df</span><span class="p">,</span> <span class="n">id_colname</span><span class="p">,</span> <span class="n">numeric_newcolname</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Passing a :py:class:`pandas.DataFrame` with a mode ID column called *id_colname*,</span>
<span class="sd">        adds the numeric mode id as a column named *numeric_newcolname* and returns it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Util</span><span class="o">.</span><span class="n">add_new_id</span><span class="p">(</span><span class="n">input_df</span><span class="p">,</span> <span class="n">id_colname</span><span class="p">,</span> <span class="n">numeric_newcolname</span><span class="p">,</span>
                               <span class="n">mapping_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modes_df</span><span class="p">[[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_NUM</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE</span><span class="p">]],</span>
                               <span class="n">mapping_id_colname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE</span><span class="p">,</span>
                               <span class="n">mapping_newid_colname</span><span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_MODE_NUM</span><span class="p">,</span>
                               <span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_fare_period_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fare_rules_ft_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split fare classes so they don&#39;t overlap</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fare_rules_ft_df</span><span class="p">[</span><span class="s2">&quot;fare_period_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fare_rules_ft_df</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span>
        <span class="c1"># FastTripsLogger.debug(&quot;remove_fare_period_overlap: initial\n%s&quot; % fare_rules_ft_df)</span>
        <span class="n">max_fare_period_id</span> <span class="o">=</span> <span class="n">fare_rules_ft_df</span><span class="p">[</span><span class="s2">&quot;fare_period_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">loop_iters</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># join with itself to see if any are contained</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span><span class="n">fare_rules_ft_df</span><span class="p">,</span>
                              <span class="n">right</span><span class="o">=</span><span class="n">fare_rules_ft_df</span><span class="p">,</span>
                              <span class="n">on</span>   <span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">,</span>
                              <span class="n">how</span>  <span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>

            <span class="c1"># if there&#39;s one fare period per fare id, nothing to do</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">fare_rules_ft_df</span><span class="p">):</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;One fare period per fare id, no need to split&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">fare_rules_ft_df</span>

            <span class="c1"># remove dupes</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fare_period_id_x&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fare_period_id_y&quot;</span><span class="p">]</span> <span class="p">]</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;remove_fare_period_overlap:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">df</span><span class="p">)</span>

            <span class="c1"># this is an overlap -- error</span>
            <span class="c1">#  ____y_______                     x starts after y starts</span>
            <span class="c1">#          ______x______            x starts before y ends</span>
            <span class="c1">#                                   x ends after y ends</span>
            <span class="n">intersecting_fare_periods</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start_time_x&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start_time_y&quot;</span><span class="p">])</span><span class="o">&amp;</span> \
                                                <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start_time_x&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end_time_y&quot;</span><span class="p">])</span><span class="o">&amp;</span> \
                                                <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end_time_x&quot;</span>  <span class="p">]</span><span class="o">&gt;</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end_time_y&quot;</span><span class="p">])</span> <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersecting_fare_periods</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Partially overlapping fare periods are ambiguous. </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">intersecting_fare_periods</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">NetworkInputError</span><span class="p">(</span><span class="n">Route</span><span class="o">.</span><span class="n">INPUT_FARE_PERIODS_FILE</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>

            <span class="c1"># is x a subset of y?</span>
            <span class="c1">#    ___x___            x starts after y starts</span>
            <span class="c1"># ______y_______        x ends before y ends</span>
            <span class="n">subset_fare_periods</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start_time_x&quot;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start_time_y&quot;</span><span class="p">])</span><span class="o">&amp;</span> \
                                          <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end_time_x&quot;</span>  <span class="p">]</span><span class="o">&lt;=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end_time_y&quot;</span><span class="p">])</span> <span class="p">]</span>
            <span class="c1"># if no subsets, done -- return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_fare_periods</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;remove_fare_period_overlap returning</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fare_rules_ft_df</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">fare_rules_ft_df</span>

            <span class="c1"># do one at a time -- split first into three rows</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;splitting</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">subset_fare_periods</span><span class="p">))</span>
            <span class="n">row_dict</span> <span class="o">=</span> <span class="n">subset_fare_periods</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">row_dict</span><span class="p">)</span>
            <span class="n">y_1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fare_id&#39;</span>          <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;fare_id&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;fare_period&#39;</span>      <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;fare_period_y&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;start_time&#39;</span>       <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;start_time_y&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;end_time&#39;</span>         <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;start_time_x&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;fare_period_id&#39;</span>   <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;fare_period_id_y&#39;</span><span class="p">]}</span>
            <span class="n">x</span>   <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fare_id&#39;</span>          <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;fare_id&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;fare_period&#39;</span>      <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;fare_period_x&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;start_time&#39;</span>       <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;start_time_x&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;end_time&#39;</span>         <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;end_time_x&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;fare_period_id&#39;</span>   <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;fare_period_id_x&#39;</span><span class="p">]}</span>
            <span class="n">y_2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fare_id&#39;</span>          <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;fare_id&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;fare_period&#39;</span>      <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;fare_period_y&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;start_time&#39;</span>       <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;end_time_x&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;end_time&#39;</span>         <span class="p">:</span><span class="n">row_dict</span><span class="p">[</span><span class="s1">&#39;end_time_y&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;fare_period_id&#39;</span>   <span class="p">:</span><span class="n">max_fare_period_id</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span> <span class="c1"># new</span>
            <span class="n">max_fare_period_id</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">y_1</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y_2</span><span class="p">])</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_df</span><span class="p">))</span>

            <span class="c1"># put it together with the unaffected fare_periodes we already had</span>
            <span class="n">prev_df</span> <span class="o">=</span> <span class="n">fare_rules_ft_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">fare_rules_ft_df</span><span class="p">[</span><span class="s2">&quot;fare_period_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="n">row_dict</span><span class="p">[</span><span class="s2">&quot;fare_period_id_x&quot;</span><span class="p">])</span><span class="o">&amp;</span>
                                            <span class="p">(</span><span class="n">fare_rules_ft_df</span><span class="p">[</span><span class="s2">&quot;fare_period_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="n">row_dict</span><span class="p">[</span><span class="s2">&quot;fare_period_id_y&quot;</span><span class="p">])</span> <span class="p">]</span>
            <span class="n">fare_rules_ft_df</span> <span class="o">=</span> <span class="n">prev_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_df</span><span class="p">)</span>

            <span class="c1"># sort by fare_id, start_time</span>
            <span class="n">fare_rules_ft_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">,</span>
                                          <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># reorder columns</span>
            <span class="n">fare_rules_ft_df</span> <span class="o">=</span> <span class="n">fare_rules_ft_df</span><span class="p">[[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">,</span>
                                                 <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_PERIOD</span><span class="p">,</span>
                                                 <span class="s2">&quot;fare_period_id&quot;</span><span class="p">,</span>
                                                 <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">,</span>
                                                 <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span><span class="p">]]</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fare_rules_ft_df</span><span class="p">))</span>

            <span class="n">loop_iters</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># don&#39;t loop forever -- there&#39;s a problem</span>
            <span class="k">if</span> <span class="n">loop_iters</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">error_str</span> <span class="o">=</span> <span class="s2">&quot;Route.remove_fare_period_overlap looping too much!  Something is wrong.&quot;</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">UnexpectedError</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>

        <span class="c1"># this shouldn&#39;t happen</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This shouldn&#39;t happen&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_routes_for_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write to an intermediate formatted file for the C++ extension.</span>
<span class="sd">        Since there are strings involved, it&#39;s easier than passing it to the extension.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.Assignment</span> <span class="kn">import</span> <span class="n">Assignment</span>
        <span class="c1"># write intermediate file -- route id num, route id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">route_id_df</span><span class="p">[[</span><span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID_NUM</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">ROUTES_COLUMN_ROUTE_ID</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">OUTPUT_ROUTE_ID_NUM_FILE</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">OUTPUT_ROUTE_ID_NUM_FILE</span><span class="p">))</span>


        <span class="c1"># write fare file</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># copy for writing</span>
            <span class="n">fare_rules_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># replace with float versions</span>
            <span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">NETWORK_BUILD_DATE_START_TIME</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
            <span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span>  <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span>  <span class="p">]</span> <span class="o">-</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">NETWORK_BUILD_DATE_START_TIME</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>

            <span class="c1"># fillna with -1</span>
            <span class="k">for</span> <span class="n">num_col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID_NUM</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID_NUM</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID_NUM</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFERS</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">num_col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                    <span class="n">fare_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">num_col</span><span class="p">]),</span> <span class="n">num_col</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">fare_rules_df</span><span class="p">[</span><span class="n">num_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">fare_rules_df</span><span class="p">[</span><span class="n">num_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fare_rules_df</span><span class="p">[</span><span class="n">num_col</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># temp column: duraton; sort by this so the smallest duration is found first</span>
            <span class="n">fare_rules_df</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span>  <span class="p">]</span> <span class="o">-</span> <span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">]</span>
            <span class="n">fare_rules_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID_NUM</span><span class="p">,</span><span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># transfer_duration fillna with -1</span>
            <span class="n">fare_rules_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFER_DURATION</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># File with fare id num, fare id, fare class, price, xfers</span>
            <span class="n">fare_rules_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">OUTPUT_FARE_ID_FILE</span><span class="p">),</span>
                                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID_NUM</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_FARE_ID</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_FARE_PERIOD</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID_NUM</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID_NUM</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID_NUM</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_PRICE</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFERS</span><span class="p">,</span>
                                         <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFER_DURATION</span><span class="p">],</span>
                                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">OUTPUT_FARE_ID_FILE</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># File with fare transfer rules</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">OUTPUT_FARE_TRANSFER_FILE</span><span class="p">),</span>
                                                   <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">OUTPUT_FARE_TRANSFER_FILE</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No fare rules so no file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">OUTPUT_FARE_ID_FILE</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_fares</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trip_links_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds (or replaces) fare columns to the given :py:class:`pandas.DataFrame`.</span>

<span class="sd">        New columns are</span>

<span class="sd">        * :py:attr:`Assignment.SIM_COL_PAX_FARE`</span>
<span class="sd">        * :py:attr:`Assignment.SIM_COL_PAX_FARE_PERIOD`</span>
<span class="sd">        * :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD`</span>
<span class="sd">        * :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_TYPE`</span>
<span class="sd">        * :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_AMOUNT`</span>
<span class="sd">        * :py:attr:`Assignment.SIM_COL_PAX_FREE_TRANSFER`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;          Adding fares to pathset&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">.Assignment</span> <span class="kn">import</span> <span class="n">Assignment</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">trip_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">trip_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span><span class="p">,</span>
                                <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span><span class="p">,</span>
                                <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD</span><span class="p">,</span>
                                <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">,</span>
                                <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span><span class="p">,</span>
                                <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># no fares configured</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span>                      <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span>               <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span>            <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span>          <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span>             <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">trip_links_df</span>

        <span class="n">orig_columns</span>     <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trip_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">fare_columns</span>     <span class="o">=</span> <span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span><span class="p">,</span>
                            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span><span class="p">]</span>
        <span class="n">transfer_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD</span><span class="p">,</span>
                            <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">,</span>
                            <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span><span class="p">,</span>
                            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">]</span>

        <span class="c1"># give them a unique index and store it for later</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;trip_links_df index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trip_links_df</span><span class="o">.</span><span class="n">index</span>

        <span class="n">num_trip_links</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;add_fares initial trips (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_trip_links</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">trip_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;add_fares initial fare_rules (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))))</span>

        <span class="c1"># initialize</span>
        <span class="n">trip_links_unmatched</span> <span class="o">=</span> <span class="n">trip_links_df</span>
        <span class="n">trip_links_matched</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">trip_links_df</span>

        <span class="kn">from</span> <span class="nn">.Passenger</span> <span class="kn">import</span> <span class="n">Passenger</span>
        <span class="c1"># level 0: match on all three</span>
        <span class="n">fare_rules0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span>      <span class="p">])</span><span class="o">&amp;</span>
                                             <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span>     <span class="p">])</span><span class="o">&amp;</span>
                                             <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">])]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fare_rules0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trip_links_match0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">trip_links_unmatched</span><span class="p">,</span>
                                             <span class="n">right</span>    <span class="o">=</span><span class="n">fare_rules0</span><span class="p">,</span>
                                             <span class="n">how</span>      <span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
                                             <span class="n">left_on</span>  <span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span><span class="p">,</span><span class="s2">&quot;A_zone_id&quot;</span><span class="p">,</span><span class="s2">&quot;B_zone_id&quot;</span><span class="p">],</span>
                                             <span class="n">right_on</span> <span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span><span class="p">,</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span><span class="p">,</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">],</span>
                                             <span class="n">suffixes</span> <span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;_fare_rules&quot;</span><span class="p">])</span>

            <span class="c1"># delete rows where the board time is not within the fare period</span>
            <span class="n">trip_links_match0</span> <span class="o">=</span> <span class="n">trip_links_match0</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">trip_links_match0</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_PRICE</span><span class="p">])</span><span class="o">|</span>
                                                      <span class="p">((</span><span class="n">trip_links_match0</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">trip_links_match0</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">])</span><span class="o">&amp;</span>
                                                       <span class="p">(</span><span class="n">trip_links_match0</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">trip_links_match0</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span><span class="p">]))</span> <span class="p">]</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;add_fares level 0 (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_match0</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trip_links_match0</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_match0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1"># update matched and unmatched == they should be disjoint with union = whole</span>
                <span class="n">trip_links_unmatched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span><span class="n">trip_links_unmatched</span><span class="p">,</span>
                                                    <span class="n">right</span><span class="o">=</span><span class="n">trip_links_match0</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]],</span>
                                                    <span class="n">how</span>  <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                                    <span class="n">on</span>   <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">],</span>
                                                    <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">trip_links_unmatched</span> <span class="o">=</span> <span class="n">trip_links_unmatched</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">trip_links_unmatched</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left_only&quot;</span> <span class="p">]</span>
                <span class="n">trip_links_unmatched</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">trip_links_matched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trip_links_matched</span><span class="p">,</span> <span class="n">trip_links_match0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;matched: </span><span class="si">%d</span><span class="s2">  unmatched: </span><span class="si">%d</span><span class="s2">   total: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_matched</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_unmatched</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_matched</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_unmatched</span><span class="p">)))</span>
                <span class="k">del</span> <span class="n">trip_links_match0</span>

                <span class="c1"># TODO - Addding stop gap solution - if there are duplicates, drop them</span>
                <span class="c1"># but there&#39;s probably a better way to handle this, like flagging in input</span>
                <span class="c1"># See https://app.asana.com/0/15582794263969/319659099709517</span>

                <span class="c1"># trip_links_matched[&quot;dupe&quot;] = trip_links_matched.duplicated(subset=&quot;trip_links_df index&quot;)</span>
                <span class="c1"># FastTripsLogger.debug(&quot;dupes: \n%s&quot; % trip_links_matched.loc[trip_links_matched[&quot;dupe&quot;]==True].sort_values(by=&quot;trip_links_df index&quot;))</span>
                <span class="n">trip_links_matched</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;trip_links_df index&quot;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># level 1: match on route only</span>
        <span class="n">fare_rules1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span>      <span class="p">])</span><span class="o">&amp;</span>
                                             <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span>     <span class="p">])</span><span class="o">&amp;</span>
                                             <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">])]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fare_rules1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trip_links_match1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">trip_links_unmatched</span><span class="p">,</span>
                                             <span class="n">right</span>    <span class="o">=</span><span class="n">fare_rules1</span><span class="p">,</span>
                                             <span class="n">how</span>      <span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
                                             <span class="n">on</span>       <span class="o">=</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span><span class="p">,</span>
                                             <span class="n">suffixes</span> <span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;_fare_rules&quot;</span><span class="p">])</span>

            <span class="c1"># delete rows where the board time is not within the fare period</span>
            <span class="n">trip_links_match1</span> <span class="o">=</span> <span class="n">trip_links_match1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">trip_links_match1</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_PRICE</span><span class="p">])</span><span class="o">|</span>
                                                      <span class="p">((</span><span class="n">trip_links_match1</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">trip_links_match1</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">])</span><span class="o">&amp;</span>
                                                       <span class="p">(</span><span class="n">trip_links_match1</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">trip_links_match1</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span><span class="p">]))</span> <span class="p">]</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;add_fares level 1 (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_match1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trip_links_match1</span><span class="o">.</span><span class="n">head</span><span class="p">())))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_match1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># update matched and unmatched == they should be disjoint with union = whole</span>
                <span class="n">trip_links_unmatched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span><span class="n">trip_links_unmatched</span><span class="p">,</span>
                                                    <span class="n">right</span><span class="o">=</span><span class="n">trip_links_match1</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]],</span>
                                                    <span class="n">how</span>  <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                                    <span class="n">on</span>   <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">],</span>
                                                    <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">trip_links_unmatched</span> <span class="o">=</span> <span class="n">trip_links_unmatched</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">trip_links_unmatched</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left_only&quot;</span> <span class="p">]</span>
                <span class="n">trip_links_unmatched</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">trip_links_matched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trip_links_matched</span><span class="p">,</span> <span class="n">trip_links_match1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;matched: </span><span class="si">%d</span><span class="s2">  unmatched: </span><span class="si">%d</span><span class="s2">   total: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_matched</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_unmatched</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_matched</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_unmatched</span><span class="p">)))</span>
                <span class="k">del</span> <span class="n">trip_links_match1</span>

        <span class="c1"># level 2: match on origin and destination zones only</span>
        <span class="n">fare_rules2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span>      <span class="p">])</span><span class="o">&amp;</span>
                                             <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span>     <span class="p">])</span><span class="o">&amp;</span>
                                             <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">])]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fare_rules2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trip_links_match2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">trip_links_unmatched</span><span class="p">,</span>
                                             <span class="n">right</span>    <span class="o">=</span><span class="n">fare_rules2</span><span class="p">,</span>
                                             <span class="n">how</span>      <span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
                                             <span class="n">left_on</span>  <span class="o">=</span><span class="p">[</span><span class="s2">&quot;A_zone_id&quot;</span><span class="p">,</span><span class="s2">&quot;B_zone_id&quot;</span><span class="p">],</span>
                                             <span class="n">right_on</span> <span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span><span class="p">,</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">],</span>
                                             <span class="n">suffixes</span> <span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;_fare_rules&quot;</span><span class="p">])</span>

            <span class="c1"># delete rows where the board time is not within the fare period</span>
            <span class="n">trip_links_match2</span> <span class="o">=</span> <span class="n">trip_links_match2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">trip_links_match2</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_PRICE</span><span class="p">])</span><span class="o">|</span>
                                                      <span class="p">((</span><span class="n">trip_links_match2</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">trip_links_match2</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">])</span><span class="o">&amp;</span>
                                                       <span class="p">(</span><span class="n">trip_links_match2</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">trip_links_match2</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span><span class="p">]))</span> <span class="p">]</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;add_fares level 2 (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_match2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trip_links_match2</span><span class="o">.</span><span class="n">head</span><span class="p">())))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_match2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># update matched and unmatched == they should be disjoint with union = whole</span>
                <span class="n">trip_links_unmatched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span><span class="n">trip_links_unmatched</span><span class="p">,</span>
                                                    <span class="n">right</span><span class="o">=</span><span class="n">trip_links_match2</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]],</span>
                                                    <span class="n">how</span>  <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                                    <span class="n">on</span>   <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">],</span>
                                                    <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">trip_links_unmatched</span> <span class="o">=</span> <span class="n">trip_links_unmatched</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">trip_links_unmatched</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left_only&quot;</span> <span class="p">]</span>
                <span class="n">trip_links_unmatched</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">trip_links_matched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trip_links_matched</span><span class="p">,</span> <span class="n">trip_links_match2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;matched: </span><span class="si">%d</span><span class="s2">  unmatched: </span><span class="si">%d</span><span class="s2">   total: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_matched</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_unmatched</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_matched</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_unmatched</span><span class="p">)))</span>
                <span class="k">del</span> <span class="n">trip_links_match2</span>

        <span class="c1"># level 3: no route, origin or destination specified</span>
        <span class="n">fare_rules3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ROUTE_ID</span>      <span class="p">])</span><span class="o">&amp;</span>
                                             <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_ORIGIN_ID</span>     <span class="p">])</span><span class="o">&amp;</span>
                                             <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_rules_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_DESTINATION_ID</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fare_rules3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># need a column to merge on</span>
            <span class="n">merge_column</span> <span class="o">=</span> <span class="s2">&quot;fare level 3 merge col&quot;</span>
            <span class="n">fare_rules3</span><span class="p">[</span><span class="n">merge_column</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">trip_links_unmatched</span><span class="p">[</span><span class="n">merge_column</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;fare_rules3 (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fare_rules3</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fare_rules3</span><span class="o">.</span><span class="n">head</span><span class="p">())))</span>

            <span class="n">trip_links_match3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">trip_links_unmatched</span><span class="p">,</span>
                                             <span class="n">right</span>    <span class="o">=</span><span class="n">fare_rules3</span><span class="p">,</span>
                                             <span class="n">how</span>      <span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
                                             <span class="n">on</span>       <span class="o">=</span><span class="n">merge_column</span><span class="p">,</span>
                                             <span class="n">suffixes</span> <span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;_fare_rules&quot;</span><span class="p">])</span>

            <span class="n">trip_links_match3</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">merge_column</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">trip_links_unmatched</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">merge_column</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># delete rows where the board time is not within the fare period</span>
            <span class="n">trip_links_match3</span> <span class="o">=</span> <span class="n">trip_links_match3</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">trip_links_match3</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_PRICE</span><span class="p">])</span><span class="o">|</span>
                                                      <span class="p">((</span><span class="n">trip_links_match3</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">trip_links_match3</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_START_TIME</span><span class="p">])</span><span class="o">&amp;</span>
                                                       <span class="p">(</span><span class="n">trip_links_match3</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">trip_links_match3</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_RULES_COLUMN_END_TIME</span><span class="p">]))</span> <span class="p">]</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;add_fares level 3 (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_match3</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trip_links_match3</span><span class="o">.</span><span class="n">head</span><span class="p">())))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_match3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># update matched and unmatched == they should be disjoint with union = whole</span>
                <span class="n">trip_links_unmatched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span><span class="n">trip_links_unmatched</span><span class="p">,</span>
                                                    <span class="n">right</span><span class="o">=</span><span class="n">trip_links_match3</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]],</span>
                                                    <span class="n">how</span>  <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                                    <span class="n">on</span>   <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                           <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">],</span>
                                                    <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">trip_links_unmatched</span> <span class="o">=</span> <span class="n">trip_links_unmatched</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">trip_links_unmatched</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left_only&quot;</span> <span class="p">]</span>
                <span class="n">trip_links_unmatched</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">trip_links_matched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trip_links_matched</span><span class="p">,</span> <span class="n">trip_links_match3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;matched: </span><span class="si">%d</span><span class="s2">  unmatched: </span><span class="si">%d</span><span class="s2">   total: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_matched</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_unmatched</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_matched</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_unmatched</span><span class="p">)))</span>
                <span class="k">del</span> <span class="n">trip_links_match3</span>

        <span class="c1"># put them together</span>
        <span class="n">trip_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trip_links_matched</span><span class="p">,</span> <span class="n">trip_links_unmatched</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span>
                                      <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                      <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                      <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                      <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">],</span>
                                      <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">trip_links_matched</span>
        <span class="k">del</span> <span class="n">trip_links_unmatched</span>

        <span class="c1"># rename price to fare</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_PRICE</span><span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># join fails mean 0</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span><span class="p">:</span><span class="mf">0.0</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># reorder columns</span>
        <span class="n">trip_links_df</span> <span class="o">=</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">orig_columns</span> <span class="o">+</span> <span class="n">fare_columns</span> <span class="o">+</span> <span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFERS</span><span class="p">,</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFER_DURATION</span><span class="p">]]</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;trip_links_df (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trip_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">())))</span>

        <span class="c1"># make sure we didn&#39;t lose or add any</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_trip_links</span>

        <span class="c1"># apply fare transfers</span>
        <span class="n">trip_links_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_fare_transfer_rules</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">)</span>

        <span class="n">trip_links_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_free_transfers</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">)</span>

        <span class="c1"># drop other columns</span>
        <span class="n">trip_links_df</span> <span class="o">=</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">orig_columns</span> <span class="o">+</span> <span class="n">fare_columns</span> <span class="o">+</span> <span class="n">transfer_columns</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">trip_links_df</span>

    <span class="k">def</span> <span class="nf">apply_fare_transfer_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trip_links_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies fare transfers by attaching previous fare period.</span>

<span class="sd">        Adds (or replaces) columns :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD`, :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_TYPE`</span>
<span class="sd">        and :py:attr:`Route.FARE_TRANSFER_RULES_COLUMN_AMOUNT` and adjusts the values in</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_FARE`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.Passenger</span> <span class="kn">import</span> <span class="n">Passenger</span>
        <span class="kn">from</span> <span class="nn">.Assignment</span> <span class="kn">import</span> <span class="n">Assignment</span>

        <span class="k">if</span> <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">trip_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">trip_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD</span><span class="p">,</span>
                                <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">,</span>
                                <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># no transfer rules =&gt; nothing to do</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">]</span>             <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span><span class="p">]</span>           <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">trip_links_df</span>

        <span class="c1"># FastTripsLogger.debug(&quot;apply_fare_transfers (%d):\n%s&quot; % (len(trip_links_df), str(trip_links_df.head(20))))</span>

        <span class="c1"># previous trip link</span>
        <span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> prev&quot;</span> <span class="o">%</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">trip_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>    <span class="o">=</span><span class="n">trip_links_df</span><span class="p">,</span>
                                     <span class="n">right</span>   <span class="o">=</span><span class="n">trip_links_df</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                                                             <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span><span class="p">]],</span>
                                     <span class="n">left_on</span> <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                               <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> prev&quot;</span> <span class="o">%</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">],</span>
                                     <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">],</span>
                                     <span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;_prev&quot;</span><span class="p">],</span>
                                     <span class="n">how</span>     <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="c1"># extra columns are linknum prev, linknum_prev, fare_prev, fare_period_prev,</span>

        <span class="c1"># join with transfers table</span>
        <span class="n">trip_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>    <span class="o">=</span><span class="n">trip_links_df</span><span class="p">,</span>
                                     <span class="n">right</span>   <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fare_transfer_rules_df</span><span class="p">,</span>
                                     <span class="n">left_on</span> <span class="o">=</span><span class="p">[</span><span class="s2">&quot;fare_period_prev&quot;</span><span class="p">,</span><span class="s2">&quot;fare_period&quot;</span><span class="p">],</span>
                                     <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD</span><span class="p">,</span>
                                               <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TO_FARE_PERIOD</span><span class="p">],</span>
                                     <span class="n">how</span>     <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="c1"># FastTripsLogger.debug(&quot;apply_fare_transfers (%d):\n%s&quot; % (len(trip_links_df), str(trip_links_df.head(20))))</span>

        <span class="c1"># keep Route.FARE_TRANSFER_RULES_COLUMN_FROM_FARE_PERIOD, Route.FARE_TRANSFER_RULES_COLUMN_TYPE, Route.FARE_TRANSFER_RULES_COLUMN_AMOUNT</span>
        <span class="c1"># so lose the rest</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> prev&quot;</span> <span class="o">%</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_prev&quot;</span> <span class="o">%</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_prev&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span><span class="p">,</span>
                            <span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TO_FARE_PERIOD</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># FastTripsLogger.debug(&quot;apply_fare_transfers (%d):\n%s&quot; % (len(trip_links_df), str(trip_links_df.head(20))))</span>

        <span class="c1"># apply transfer discount</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">])</span><span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">]</span><span class="o">==</span><span class="n">Route</span><span class="o">.</span><span class="n">TRANSFER_TYPE_TRANSFER_DISCOUNT</span><span class="p">),</span>
                           <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span><span class="p">]</span> <span class="o">-</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span><span class="p">]</span>

        <span class="c1"># apply transfer free</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">])</span><span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">]</span><span class="o">==</span><span class="n">Route</span><span class="o">.</span><span class="n">TRANSFER_TYPE_TRANSFER_FREE</span><span class="p">),</span>
                           <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># apply transfer fare</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">])</span><span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_TYPE</span><span class="p">]</span><span class="o">==</span><span class="n">Route</span><span class="o">.</span><span class="n">TRANSFER_TYPE_TRANSFER_COST</span><span class="p">),</span>
                           <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_TRANSFER_RULES_COLUMN_AMOUNT</span><span class="p">]</span>

        <span class="c1"># make sure it&#39;s not negative</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;apply_fare_transfers (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trip_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">trip_links_df</span>


    <span class="k">def</span> <span class="nf">apply_free_transfers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trip_links_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the free transfers allowed in  to trip_links_df fare_attributes_ft.txt (configured by columns transfers, transfer_duration).</span>
<span class="sd">        Sets columns Assignment.SIM_COL_PAX_FREE_TRANSFER to None, 0.0 or 1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># free transfers within a fare id</span>
        <span class="kn">from</span> <span class="nn">.Assignment</span> <span class="kn">import</span> <span class="n">Assignment</span>
        <span class="kn">from</span> <span class="nn">.Passenger</span>  <span class="kn">import</span> <span class="n">Passenger</span>
        <span class="kn">from</span> <span class="nn">.PathSet</span>    <span class="kn">import</span> <span class="n">PathSet</span>

        <span class="c1"># create a fare_index that counts up for a unique person-trip id, pathnum, and fare_period</span>
        <span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;fare_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trip_links_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                             <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span><span class="p">])</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">!=</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_TRIP</span><span class="p">,</span> <span class="s2">&quot;fare_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>


        <span class="c1"># transfer_time in seconds (to compare with transfer_duration) get the first fare board</span>
        <span class="n">first_fare_board</span> <span class="o">=</span> <span class="n">trip_links_df</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                          <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                          <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                          <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                                          <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span><span class="p">,</span>
                                          <span class="s2">&quot;fare_index&quot;</span><span class="p">,</span>
                                          <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;fare_index&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;apply_free_transfers: first_fare_board=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">first_fare_board</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>

        <span class="n">trip_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>    <span class="o">=</span><span class="n">trip_links_df</span><span class="p">,</span>
                                     <span class="n">right</span>   <span class="o">=</span><span class="n">first_fare_board</span><span class="p">,</span>
                                     <span class="n">on</span>      <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                               <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span><span class="p">],</span>
                                     <span class="n">how</span>     <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                     <span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;_ffb&quot;</span><span class="p">])</span>
        <span class="c1"># calculate time from first board (for this fare period id) in seconds</span>
        <span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;transfer_time_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span><span class="o">-</span><span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_ffb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

        <span class="c1"># FastTripsLogger.debug(&quot;apply_free_transfers: trip_links_df=\n%s&quot; % str(trip_links_df.loc[ trip_links_df[&quot;transfer_time_sec&quot;] &gt;0 ]))</span>

        <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># free transfer if transfers &gt; 0 and 0 &lt; fare_index &lt;= transfers</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFERS</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span>                          <span class="c1"># transfers &gt; 0</span>
                           <span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;fare_index&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span>                                                <span class="c1"># is a transfer</span>
                           <span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;fare_index&quot;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFERS</span><span class="p">]),</span> <span class="c1"># is within the number of free transfers allowed</span>
                                    <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1"># only applicable to transit links</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">!=</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_TRIP</span><span class="p">,</span>
                                    <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># only applicable if transfer is within transfer_duration -- revoke if transfer_time_sec &gt; transfer duration</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">]</span><span class="o">==</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;transfer_time_sec&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFER_DURATION</span><span class="p">]),</span>
                                    <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># make the transfer free</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">]</span><span class="o">==</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># debug: show transfers within fare period</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;apply_free_transfers: fare_index&gt;0</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                                                                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">,</span>
                                                                                              <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">,</span>
                                                                                              <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span><span class="p">,</span>
                                                                                              <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFERS</span><span class="p">,</span>
                                                                                              <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFER_DURATION</span><span class="p">,</span><span class="s2">&quot;transfer_time_sec&quot;</span><span class="p">,</span>
                                                                                              <span class="s2">&quot;fare_index&quot;</span><span class="p">,</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">]]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trip_links_df</span><span class="p">[</span><span class="s2">&quot;fare_index&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
        <span class="c1"># debug: show transfers within fare period</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;apply_free_transfers: free_transfer=1.0</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">trip_links_df</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                                                                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">,</span>
                                                                                              <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">,</span>
                                                                                              <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FARE_PERIOD</span><span class="p">,</span>
                                                                                              <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFERS</span><span class="p">,</span>
                                                                                              <span class="n">Route</span><span class="o">.</span><span class="n">FARE_ATTR_COLUMN_TRANSFER_DURATION</span><span class="p">,</span><span class="s2">&quot;transfer_time_sec&quot;</span><span class="p">,</span>
                                                                                              <span class="s2">&quot;fare_index&quot;</span><span class="p">,</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">]]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trip_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_FREE_TRANSFER</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>



        <span class="c1"># drop new columns</span>
        <span class="n">trip_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;fare_index&quot;</span><span class="p">,</span> <span class="s2">&quot;fare_index_ffb&quot;</span><span class="p">,</span> <span class="s2">&quot;transfer_time_sec&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_ffb&quot;</span> <span class="o">%</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_ffb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trip_links_df</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2015-2018, Lisa Zorn.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
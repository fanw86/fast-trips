

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>fasttrips.Assignment &mdash; fasttrips Development Branch Commit 5e504cb3319b58faac3aca1310cb4ad08dc44ed8 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> fasttrips
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howitworks.html">How Fast-Trips Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io.html">Input/Output Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Using Fast-Trips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Fast-Trips Classes and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fasttrips</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>fasttrips.Assignment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fasttrips.Assignment</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">past.builtins</span> <span class="kn">import</span> <span class="n">execfile</span>
<span class="kn">from</span> <span class="nn">future</span> <span class="kn">import</span> <span class="n">standard_library</span>
<span class="n">standard_library</span><span class="o">.</span><span class="n">install_aliases</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">object</span>

<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2015-2017 Contributing Entities&quot;</span>
<span class="n">__license__</span>   <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s2">    you may not use this file except in compliance with the License.</span>
<span class="s2">    You may obtain a copy of the License at</span>

<span class="s2">        http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="s2">    Unless required by applicable law or agreed to in writing, software</span>
<span class="s2">    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s2">    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s2">    See the License for the specific language governing permissions and</span>
<span class="s2">    limitations under the License.</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">_fasttrips</span>
<span class="kn">from</span> <span class="nn">.Error</span> <span class="kn">import</span> <span class="n">ConfigurationError</span>
<span class="kn">from</span> <span class="nn">.Logger</span> <span class="kn">import</span> <span class="n">FastTripsLogger</span><span class="p">,</span> <span class="n">setupLogging</span>
<span class="kn">from</span> <span class="nn">.Passenger</span> <span class="kn">import</span> <span class="n">Passenger</span>
<span class="kn">from</span> <span class="nn">.PathSet</span> <span class="kn">import</span> <span class="n">PathSet</span>
<span class="kn">from</span> <span class="nn">.Performance</span> <span class="kn">import</span> <span class="n">Performance</span>
<span class="kn">from</span> <span class="nn">.Trip</span> <span class="kn">import</span> <span class="n">Trip</span>
<span class="kn">from</span> <span class="nn">.TAZ</span> <span class="kn">import</span> <span class="n">TAZ</span>
<span class="kn">from</span> <span class="nn">.Util</span> <span class="kn">import</span> <span class="n">Util</span>


<div class="viewcode-block" id="Assignment"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment">[docs]</a><span class="k">class</span> <span class="nc">Assignment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assignment class.  Documentation forthcoming.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: Configuration file for fasttrips</span>
    <span class="n">CONFIGURATION_FILE</span>              <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#: Configuration functions</span>
    <span class="n">CONFIGURATION_FUNCTIONS_FILE</span>    <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Output copy of the configuration file in case anything got overridden</span>
    <span class="c1">#: (Hmm naming conventions are a bit awkward here)</span>
    <span class="n">CONFIGURATION_OUTPUT_FILE</span>       <span class="o">=</span> <span class="s1">&#39;ft_output_config.txt&#39;</span>

    <span class="c1">#: Configuration: Input network directory</span>
    <span class="n">INPUT_NETWORK_ARCHIVE</span>               <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#: Configuration: Input demand directory</span>
    <span class="n">INPUT_DEMAND_DIR</span>                <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#: Configuration: Pathweight parameters</span>
    <span class="n">INPUT_WEIGHTS</span>                   <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#: Configuration: Run Configuration</span>
    <span class="n">OUTPUT_DIR</span>                      <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Configuration: Maximum number of iterations to remove capacity violations. When</span>
    <span class="c1">#: the transit system is not crowded or when capacity constraint is</span>
    <span class="c1">#: relaxed the model will terminate after the first iteration</span>
    <span class="n">MAX_ITERATIONS</span>                  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">MAX_PF_ITERATIONS</span>               <span class="o">=</span> <span class="mi">10</span>
    <span class="n">CONVERGENCE_GAP</span>                 <span class="o">=</span> <span class="kc">None</span>

    <span class="n">NETWORK_BUILD_DATE</span>              <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">NETWORK_BUILD_DATE_START_TIME</span>   <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">NETWORK_BUILD_DATE</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="c1">#: Find paths deterministically, using shortest path search based on travel time.</span>
    <span class="n">PATHFINDING_TYPE_DETERMINISTIC</span>  <span class="o">=</span> <span class="s1">&#39;deterministic&#39;</span>
    <span class="c1">#: Find paths stochastically using trip-based hyperpath</span>
    <span class="n">PATHFINDING_TYPE_STOCHASTIC</span>     <span class="o">=</span> <span class="s1">&#39;stochastic&#39;</span>
    <span class="c1">#: Don&#39;t find paths; read :py:attr:`Passenger.PF_PATHS_CSV` and :py:attr:`Passenger.PF_LINKS_CSV`.</span>
    <span class="n">PATHFINDING_TYPE_READ_FILE</span>      <span class="o">=</span> <span class="s1">&#39;file&#39;</span>
    <span class="c1">#: Configuration: Pathfinding Type.  Should be one of `Deterministic`, `Stochastic` or `File`</span>
    <span class="n">PATHFINDING_TYPE</span>                <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Configuration: Do simulation? It should be True for iterative assignment. In a one shot</span>
    <span class="c1">#: assignment with simulation flag off, the passengers are assigned to</span>
    <span class="c1">#: paths but are not loaded to the network.  Boolean.</span>
    <span class="n">SIMULATION</span>                      <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Configuration: Passenger trajectory output flag. Passengers&#39; path and time will be</span>
    <span class="c1">#: reported if this flag is on. Note that the simulation flag should be on for</span>
    <span class="c1">#: passengers&#39; time.  Boolean.</span>
    <span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span>   <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Configuration: If true, outputs pathset every simulation iteration.  If false,</span>
    <span class="c1">#: outputs pathset every path-finding iteration.</span>
    <span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span>     <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Configuration: Path time-window. This is the time in which the paths are generated.</span>
    <span class="c1">#: E.g. with a typical 30 min window, any path within 30 min of the</span>
    <span class="c1">#: departure time will be checked.  A :py:class:`datetime.timedelta` instance.</span>
    <span class="n">TIME_WINDOW</span>                     <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Configuration: Create skims flag. This is specific to the travel demand models</span>
    <span class="c1">#: (not working in this version). Boolean.</span>
    <span class="n">CREATE_SKIMS</span>                    <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Configuration: Beginning of the time period for which the skim is required.</span>
    <span class="c1">#:  (specify as &#39;HH:MM&#39;). A :py:class:`datetime.datetime` instance.</span>
    <span class="n">SKIM_START_TIME</span>                 <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Configuration: End of the time period for which the skim is required</span>
    <span class="c1">#: (specify as &#39;HH:MM&#39;). A :py:class:`datetime.datetime` instance.</span>
    <span class="n">SKIM_END_TIME</span>                   <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Route choice configuration: Max number of paths in a pathset.</span>
    <span class="c1">#: Used in conjuntion with :py:attr:`Assignment.MIN_PATH_PROBABILITY`</span>
    <span class="n">MAX_NUM_PATHS</span>                   <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Route choice configuration: Minimum path probability for the path to be used.</span>
    <span class="c1">#: Used in conjucntion with :py:attr:`Assignment.MAX_NUM_PATHS`, so it only</span>
    <span class="c1">#: kicks in if that is specified AND we hit it, then we start dropping using</span>
    <span class="c1">#: this threshhold.</span>
    <span class="n">MIN_PATH_PROBABILITY</span>            <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Route choice configuration: Dispersion parameter in the logit function.</span>
    <span class="c1">#: Higher values result in less stochasticity. Must be nonnegative.</span>
    <span class="c1">#: If unknown use a value between 0.5 and 1. Float.</span>
    <span class="n">STOCH_DISPERSION</span>                <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Stop labeling configuration: Multiplies the utilities by this factor</span>
    <span class="c1">#: so that there are not negative costs labels which can result in</span>
    <span class="c1">#: lengthy and ineffective path-finding. Must be positive; should be greater</span>
    <span class="c1">#: than 1.0.  Double.</span>
    <span class="n">UTILS_CONVERSION</span>                <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: In path-finding, suppress trying to adjust fares using transfer fare rules.</span>
    <span class="c1">#: This is for performance testing.</span>
    <span class="n">TRANSFER_FARE_IGNORE_PATHFINDING</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#: In path-enumeration, suppress trying to adjust fares using transfer fare rules.</span>
    <span class="c1">#: This is for performance testing.</span>
    <span class="n">TRANSFER_FARE_IGNORE_PATHENUM</span>    <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Route choice configuration: How many times max times should we process a stop</span>
    <span class="c1">#: during labeling?  Use -1 to specify no max.  Int.</span>
    <span class="c1">#: Setting this to a positive value may increase runtime but may decrease</span>
    <span class="c1">#: pathset quality. (Todo: test/quantify this.)</span>
    <span class="n">STOCH_MAX_STOP_PROCESS_COUNT</span>    <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Route choice configuration: How many stochastic paths will we generate</span>
    <span class="c1">#: (not necessarily unique) to define a path choice set?  Int.</span>
    <span class="n">STOCH_PATHSET_SIZE</span>              <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Route choice configuration: Use vehicle capacity constraints. Boolean.</span>
    <span class="n">CAPACITY_CONSTRAINT</span>             <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Debug mode: only run trace passengers</span>
    <span class="n">DEBUG_TRACE_ONLY</span>                <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Debug mode: only run this number of trips, -1 to run all. Int.</span>
    <span class="n">DEBUG_NUM_TRIPS</span>                 <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1">#: Debug: include debug columns in output</span>
    <span class="n">DEBUG_OUTPUT_COLUMNS</span>            <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Fare zone symmetry. If True, will assume fare zone symmetry.  That is, if fare_id X is</span>
    <span class="c1"># configured from origin zone A to destination zone B, and there is no fare configured</span>
    <span class="c1"># from zone B to zone A, we&#39;ll assume that fare_id X also applies.</span>
    <span class="n">FARE_ZONE_SYMMETRY</span>              <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Skip these passengers</span>
    <span class="n">SKIP_PERSON_IDS</span>                 <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Trace these persons/person trips (a list of tuples)</span>
    <span class="n">TRACE_IDS</span>                       <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#: Prepend the route id to the trip id?  This is for readability in debugging, since</span>
    <span class="c1">#: route IDs are typically more readable and trip ids are inscrutable</span>
    <span class="n">PREPEND_ROUTE_ID_TO_TRIP_ID</span>     <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Number of processes to use for path finding (via :py:mod:`multiprocessing`)</span>
    <span class="c1">#: Set to 1 to run everything in this process</span>
    <span class="c1">#: Set to less than 1 to use the result of :py:func:`multiprocessing.cpu_count`</span>
    <span class="c1">#: Set to positive integer greater than 1 to set a fixed number of processes</span>
    <span class="n">NUMBER_OF_PROCESSES</span>             <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Extra time so passengers don&#39;t get bumped (?). A :py:class:`datetime.timedelta` instance.</span>
    <span class="n">BUMP_BUFFER</span>                     <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: This is the only simulation state that exists across iterations</span>
    <span class="c1">#: It&#39;s a dictionary of (trip_id, stop_id) -&gt; earliest time a bumped passenger started waiting</span>
    <span class="n">bump_wait</span>                       <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bump_wait_df</span>                    <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Simulation: bump one stop at a time (slower, more accurate)</span>
    <span class="c1">#:</span>
    <span class="c1">#: When addressing capacity constraints in simulation, we look at all the (trip, stop)-pairs</span>
    <span class="c1">#: where the boards are not allowed since vehicle is over capacity.  The faster way to address</span>
    <span class="c1">#: this is to bump all of those passengers, which means we call the assigned path bad and try</span>
    <span class="c1">#: to reassign.</span>
    <span class="c1">#:</span>
    <span class="c1">#: However, this could over-bump passengers, because if a passenger rides multiple</span>
    <span class="c1">#: crowded vehicles, then bumping her frees up space on other vehicles and so some other bumping</span>
    <span class="c1">#: may not be necessary.  Thus, the more accurate (but slower) method is to bump passengers from</span>
    <span class="c1">#: each (trip,stop) at a time, in order of the full vehicle arrival time, and then recalculate</span>
    <span class="c1">#: loads, and iterate until we have no capacity issues.  Boolean.</span>
    <span class="n">BUMP_ONE_AT_A_TIME</span>              <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: MSA the results that affect the next iteration to avoid oscillation: boards, alights, overcap onboard at stops</span>
    <span class="n">MSA_RESULTS</span>                     <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Are we finding paths for everyone right now?  Or just un-arrived folks?</span>
    <span class="n">PATHFINDING_EVERYONE</span>            <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#: How many Simulation Iterations should we do before going back to path-finding?</span>
    <span class="n">MAX_SIMULATION_ITERS</span>            <span class="o">=</span> <span class="mi">10</span>

    <span class="c1">#: Column names for simulation</span>
    <span class="n">SIM_COL_PAX_BOARD_TIME</span>          <span class="o">=</span> <span class="s1">&#39;board_time&#39;</span>       <span class="c1">#: Board time on the transit vehicle</span>
    <span class="n">SIM_COL_PAX_ALIGHT_TIME</span>         <span class="o">=</span> <span class="s1">&#39;alight_time&#39;</span>      <span class="c1">#: Alight time from the transit vehicle</span>

    <span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span>    <span class="o">=</span> <span class="s1">&#39;alight_delay_min&#39;</span> <span class="c1">#: Delay in alight_time from original pathfinding understanding of alight time</span>
    <span class="n">SIM_COL_PAX_A_TIME</span>              <span class="o">=</span> <span class="s1">&#39;new_A_time&#39;</span>       <span class="c1">#: Time of arrival at A</span>
    <span class="n">SIM_COL_PAX_B_TIME</span>              <span class="o">=</span> <span class="s1">&#39;new_B_time&#39;</span>       <span class="c1">#: Time of arrival at B</span>
    <span class="n">SIM_COL_PAX_LINK_TIME</span>           <span class="o">=</span> <span class="s1">&#39;new_linktime&#39;</span>     <span class="c1">#: Link time (SIM_COL_PAX_B_TIME - SIM_COL_PAX_A_TIME)</span>
    <span class="n">SIM_COL_PAX_WAIT_TIME</span>           <span class="o">=</span> <span class="s1">&#39;new_waittime&#39;</span>     <span class="c1">#: Wait time</span>
    <span class="n">SIM_COL_PAX_MISSED_XFER</span>         <span class="o">=</span> <span class="s1">&#39;missed_xfer&#39;</span>      <span class="c1">#: Is this link a missed transfer</span>

    <span class="n">SIM_COL_PAX_OVERCAP</span>             <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span>      <span class="c1">#:</span>
    <span class="n">SIM_COL_PAX_OVERCAP_FRAC</span>        <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span> <span class="c1">#: If board at an overcap stop, fraction of boards that are overcap</span>
    <span class="n">SIM_COL_PAX_BUMP_ITER</span>           <span class="o">=</span> <span class="s1">&#39;bump_iter&#39;</span>
    <span class="n">SIM_COL_PAX_BOARD_STATE</span>         <span class="o">=</span> <span class="s1">&#39;board_state&#39;</span>      <span class="c1">#: NaN if not relevent, 1 if lucky enough to board at an at- or over-capacity stop, 0 if bumped.  Set by :py:meth:`Assignment.flag_bump_overcap_passengers`</span>
    <span class="n">SIM_COL_PAX_DISTANCE</span>            <span class="o">=</span> <span class="s2">&quot;distance&quot;</span>         <span class="c1">#: Link distance</span>
    <span class="n">SIM_COL_PAX_FARE</span>                <span class="o">=</span> <span class="s2">&quot;fare&quot;</span>             <span class="c1">#: Link fare in currency</span>
    <span class="n">SIM_COL_PAX_FARE_PERIOD</span>         <span class="o">=</span> <span class="s2">&quot;fare_period&quot;</span>      <span class="c1">#: Fare period id</span>
    <span class="n">SIM_COL_PAX_FREE_TRANSFER</span>       <span class="o">=</span> <span class="s2">&quot;free_transfer&quot;</span>    <span class="c1">#: Free transfer?  NaN, 0.0 or 1.0, only free based on `fare_attributes_ft.txt`</span>
    <span class="n">SIM_COL_PAX_COST</span>                <span class="o">=</span> <span class="s1">&#39;sim_cost&#39;</span>         <span class="c1">#: Link cost. (Cannot be `cost` because it collides with TAZ.DRIVE_ACCESS_COLUMN_COST)</span>
    <span class="n">SIM_COL_PAX_LNPS</span>                <span class="o">=</span> <span class="s1">&#39;ln_PS&#39;</span>            <span class="c1">#: log(PathSize)</span>
    <span class="n">SIM_COL_PAX_PROBABILITY</span>         <span class="o">=</span> <span class="s1">&#39;probability&#39;</span>      <span class="c1">#: Probability of this path</span>
    <span class="n">SIM_COL_PAX_LOGSUM</span>              <span class="o">=</span> <span class="s1">&#39;logsum&#39;</span>           <span class="c1">#: Logsum of all paths</span>

    <span class="c1">#: Is this link/path a missed transfer?</span>
    <span class="c1">#: Set in both pathset links and pathset paths, this is a 1 or 0</span>
    <span class="n">SIM_COL_MISSED_XFER</span>             <span class="o">=</span> <span class="s1">&#39;missed_xfer&#39;</span>

    <span class="c1">#: Values for :py:attr:`Assignment.SIM_COL_PAX_BOARD_STATE` column</span>
    <span class="n">BOARD_STATE_CATEGORICAL</span>    <span class="o">=</span> <span class="p">[</span> \
        <span class="s2">&quot;board_easy&quot;</span><span class="p">,</span>       <span class="c1">#: path chosen and no capacity problems</span>
        <span class="s2">&quot;boarded&quot;</span><span class="p">,</span>          <span class="c1">#: path chosen and lucky enough to board an at-capacity or over-capacity vehicle</span>
        <span class="s2">&quot;bumped&quot;</span><span class="p">,</span>           <span class="c1">#: path chosen but bumped due to capacity problems</span>
        <span class="s2">&quot;bumped_othertrip&quot;</span><span class="p">,</span> <span class="c1">#: path invalidated due to being bumped on another link of this person&#39;s trip</span>
        <span class="s2">&quot;bumped_unchosen&quot;</span><span class="p">]</span>  <span class="c1">#: path invalidated before ever chosen due to capacity problems</span>

    <span class="c1">#: Chosen status for path</span>
    <span class="n">SIM_COL_PAX_CHOSEN</span>              <span class="o">=</span> <span class="s1">&#39;chosen&#39;</span>
    <span class="c1">#: categories for SIM_COL_PAX_CHOSEN</span>
    <span class="n">CHOSEN_NOT_CHOSEN_YET</span>           <span class="o">=</span> <span class="s2">&quot;unchosen&quot;</span>
    <span class="n">CHOSEN_REJECTED</span>                 <span class="o">=</span> <span class="s2">&quot;rejected&quot;</span>
    <span class="c1">#: These will be ordered, so to select chosen, choose those &gt; CHOSEN_NOT_CHOSEN_YET</span>
    <span class="n">CHOSEN_CATEGORIES</span>               <span class="o">=</span> <span class="p">[</span><span class="n">CHOSEN_REJECTED</span><span class="p">,</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">]</span>

<div class="viewcode-block" id="Assignment.__init__"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This does nothing.  Assignment methods are static methods for now.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_functions</span><span class="p">(</span><span class="n">func_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the functions from :py:attr:`Assignment.CONFIGURATION_FUNCTIONS_FILE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Functions are defined in here -- read this and eval it</span>
        <span class="k">if</span> <span class="n">func_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">func_file</span><span class="p">):</span>
            <span class="n">my_globals</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">func_file</span><span class="p">)</span>
            <span class="n">execfile</span><span class="p">(</span><span class="n">func_file</span><span class="p">,</span> <span class="n">my_globals</span><span class="p">,</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">CONFIGURED_FUNCTIONS</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PathSet.CONFIGURED_FUNCTIONS = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">CONFIGURED_FUNCTIONS</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_configuration</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the configuration parameters from :py:attr:`Assignment.CONFIGURATION_FILE`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span>      <span class="mi">1000</span><span class="p">)</span>
        <span class="c1"># pd.set_option(&#39;display.height&#39;,   1000)</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span>   <span class="mi">1000</span><span class="p">)</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">(</span>
            <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_iterations&#39;</span>                  <span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                      <span class="s1">&#39;max_pf_iterations&#39;</span>               <span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                      <span class="s1">&#39;network_build_date&#39;</span>              <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y&quot;</span><span class="p">),</span>
                      <span class="s1">&#39;simulation&#39;</span>                      <span class="p">:</span><span class="s1">&#39;True&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;learning_convergence&#39;</span>            <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;learning_rate&#39;</span>                   <span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
                      <span class="s1">&#39;convergence_gap&#39;</span>                 <span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
                      <span class="s1">&#39;output_pathset_per_sim_iter&#39;</span>     <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;output_passenger_trajectories&#39;</span>   <span class="p">:</span><span class="s1">&#39;True&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;create_skims&#39;</span>                    <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;skim_start_time&#39;</span>                 <span class="p">:</span><span class="s1">&#39;5:00&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;skim_end_time&#39;</span>                   <span class="p">:</span><span class="s1">&#39;10:00&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;capacity_constraint&#39;</span>             <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;skip_person_ids&#39;</span>                 <span class="p">:</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;trace_ids&#39;</span>                       <span class="p">:[],</span>
                      <span class="s1">&#39;debug_trace_only&#39;</span>                <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;debug_num_trips&#39;</span>                 <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="s1">&#39;debug_output_columns&#39;</span>            <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;fare_zone_symmetry&#39;</span>              <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;prepend_route_id_to_trip_id&#39;</span>     <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;number_of_processes&#39;</span>             <span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                      <span class="s1">&#39;bump_buffer&#39;</span>                     <span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                      <span class="s1">&#39;bump_one_at_a_time&#39;</span>              <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>

                      <span class="c1"># pathfinding</span>
                      <span class="s1">&#39;max_num_paths&#39;</span>                    <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="s1">&#39;min_path_probability&#39;</span>             <span class="p">:</span><span class="mf">0.005</span><span class="p">,</span>
                      <span class="s1">&#39;min_transfer_penalty&#39;</span>             <span class="p">:</span><span class="mf">0.1</span><span class="p">,</span>
                      <span class="s1">&#39;overlap_chunk_size&#39;</span>               <span class="p">:</span><span class="mi">500</span><span class="p">,</span>
                      <span class="s1">&#39;overlap_scale_parameter&#39;</span>          <span class="p">:</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="s1">&#39;overlap_split_transit&#39;</span>            <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;overlap_variable&#39;</span>                 <span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;pathfinding_type&#39;</span>                 <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span>
                      <span class="s1">&#39;pathweights_fixed_width&#39;</span>          <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;utils_conversion_factor&#39;</span>         <span class="p">:</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="s1">&#39;stochastic_dispersion&#39;</span>            <span class="p">:</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="s1">&#39;stochastic_max_stop_process_count&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
                      <span class="s1">&#39;stochastic_pathset_size&#39;</span>          <span class="p">:</span><span class="mi">1000</span><span class="p">,</span>
                      <span class="s1">&#39;time_window&#39;</span>                      <span class="p">:</span><span class="mi">30</span><span class="p">,</span>
                      <span class="s1">&#39;transfer_fare_ignore_pathfinding&#39;</span> <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;transfer_fare_ignore_pathenum&#39;</span>    <span class="p">:</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;user_class_function&#39;</span>              <span class="p">:</span><span class="s1">&#39;generic_user_class&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;arrive_late_allowed_min&#39;</span>          <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="s1">&#39;depart_early_allowed_min&#39;</span>         <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="p">})</span>

        <span class="c1"># Read configuration from specified configuration directory</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading configuration file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config_fullpath</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">)</span>

        <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_ITERATIONS</span>                <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;max_iterations&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_PF_ITERATIONS</span>                <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span> <span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;max_pf_iterations&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">NETWORK_BUILD_DATE</span>            <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                                                    <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span> <span class="s1">&#39;network_build_date&#39;</span><span class="p">),</span> <span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">NETWORK_BUILD_DATE_START_TIME</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">NETWORK_BUILD_DATE</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">SIMULATION</span>                    <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">LEARN_ROUTES</span>                     <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_convergence&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">LEARN_ROUTES_RATE</span>                <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">CONVERGENCE_GAP</span>               <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span> <span class="s1">&#39;convergence_gap&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;output_passenger_trajectories&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span>   <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;output_pathset_per_sim_iter&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">CREATE_SKIMS</span>                  <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;create_skims&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIM_START_TIME</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                                                   <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;skim_start_time&#39;</span><span class="p">),</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIM_END_TIME</span>   <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                                                   <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;skim_end_time&#39;</span><span class="p">),</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">CAPACITY_CONSTRAINT</span>           <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;capacity_constraint&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span>               <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;skip_person_ids&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span>                     <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;trace_ids&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Must have a TRACE_IDS line in config_ft.txt; even if it is trace_ids = []&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_TRACE_ONLY</span>              <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;debug_trace_only&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span>               <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;debug_num_trips&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span>          <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;debug_output_columns&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">FARE_ZONE_SYMMETRY</span>            <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;fare_zone_symmetry&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">PREPEND_ROUTE_ID_TO_TRIP_ID</span>   <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;prepend_route_id_to_trip_id&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span>           <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;number_of_processes&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_BUFFER</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                                         <span class="n">minutes</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;bump_buffer&#39;</span><span class="p">))</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span>            <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;bump_one_at_a_time&#39;</span><span class="p">)</span>

        <span class="c1"># pathfinding</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_NUM_PATHS</span>                 <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;max_num_paths&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">MIN_PATH_PROBABILITY</span>          <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;min_path_probability&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">MIN_TRANSFER_PENALTY</span>             <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;min_transfer_penalty&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_CHUNK_SIZE</span>               <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;overlap_chunk_size&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_SCALE_PARAMETER</span>          <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;overlap_scale_parameter&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_SPLIT_TRANSIT</span>            <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;overlap_split_transit&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE</span>                 <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;overlap_variable&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span>              <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;pathfinding_type&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_FIXED_WIDTH</span>              <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;pathweights_fixed_width&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span>              <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;stochastic_dispersion&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">UTILS_CONVERSION</span>              <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;utils_conversion_factor&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_MAX_STOP_PROCESS_COUNT</span>  <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;stochastic_max_stop_process_count&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_PATHSET_SIZE</span>            <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getint</span>    <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;stochastic_pathset_size&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">TIME_WINDOW</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                                         <span class="n">minutes</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;time_window&#39;</span><span class="p">))</span>

        <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHFINDING</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;transfer_fare_ignore_pathfinding&#39;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHENUM</span>    <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;transfer_fare_ignore_pathenum&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">USER_CLASS_FUNCTION</span>                 <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span>       <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;user_class_function&#39;</span><span class="p">)</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">DEPART_EARLY_ALLOWED_MIN</span>            <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                                            <span class="n">minutes</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span> <span class="s1">&#39;depart_early_allowed_min&#39;</span><span class="p">))</span>
        <span class="n">PathSet</span><span class="o">.</span><span class="n">ARRIVE_LATE_ALLOWED_MIN</span>             <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                                            <span class="n">minutes</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getfloat</span>  <span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;arrive_late_allowed_min&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span> \
                                               <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_DETERMINISTIC</span><span class="p">,</span> \
                                               <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_READ_FILE</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;pathfinding type [</span><span class="si">%s</span><span class="s2">] not available. Expected values: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span><span class="p">,</span> <span class="nb">str</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_DETERMINISTIC</span><span class="p">,</span>  <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_READ_FILE</span><span class="p">]))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE_OPTIONS</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;pathfinding.overlap_variable [</span><span class="si">%s</span><span class="s2">] not defined. Expected values: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE_OPTIONS</span><span class="p">))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">USER_CLASS_FUNCTION</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">CONFIGURED_FUNCTIONS</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;User class function [</span><span class="si">%s</span><span class="s2">] not defined.  Please check your function file [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">USER_CLASS_FUNCTION</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">config_fullpath</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_weights</span><span class="p">(</span><span class="n">weights_file</span> <span class="o">=</span> <span class="n">INPUT_WEIGHTS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the weights from :py:attr:`Assignment.INPUT_WEIGHTS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">weights_file</span><span class="p">):</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;No path weights file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">weights_file</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_FIXED_WIDTH</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="n">weights_file</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_PURPOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_PURPOSE</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_PURPOSE</span><span class="p">)</span>
            <span class="c1">##LMZ</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">weights_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_PURPOSE</span><span class="p">:</span><span class="s1">&#39;S&#39;</span><span class="p">},</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_DF</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">process_weight_qualifiers</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Weights =</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_DF</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Weight types = </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_DF</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">process_weight_qualifiers</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Qualifiers are used to change the default behavior of weight_names. Qualifiers</span>
<span class="sd">        are added by adding a period (.) after the weight_name and specifying the</span>
<span class="sd">        qualifier name. Qualifier attributes are specified after a second dot.</span>

<span class="sd">        For example: depart_early_cost_min.logistic.growth_rate</span>
<span class="sd">        depart_early_cost_min is being qualified as a logistic penalty instead of the default</span>
<span class="sd">        behavior. growth_rate is an attribute of the logistic qualifier.</span>
<span class="sd">        :param weights: vertically oriented qualifiers</span>
<span class="sd">        :return: pivoted weights table with the qualifiers normalized horizontally.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">growth_type</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">weights</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;\.&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">qualifiers</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">weights</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;\.&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="o">~</span><span class="n">weights</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;\.&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">CONSTANT_GROWTH_MODEL</span>

        <span class="c1"># if only &#39;linear&#39; this process is done and can return</span>
        <span class="k">if</span> <span class="n">growth_type</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">weights</span>

        <span class="n">growth_type</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">growth_type</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;((?&lt;=\.)\w+)&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">growth_type</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">growth_type</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;(\w+(?=\.))&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">weights</span><span class="p">,</span> <span class="n">growth_type</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">weights</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_TYPE</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PENALTY_GROWTH_MODELS</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;Invalid qualifier type specified.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Invalid qualifier type specified.&#39;</span><span class="p">)</span>

        <span class="c1"># if only &#39;constant&#39; and &#39;exponential&#39; this process is done and can return.</span>
        <span class="k">if</span> <span class="n">qualifiers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">weights</span>

        <span class="n">qualifiers</span> <span class="o">=</span> <span class="n">qualifiers</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_NAME</span><span class="p">:</span> <span class="s1">&#39;qualifier&#39;</span><span class="p">})</span>
        <span class="n">qualifiers</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">qualifiers</span><span class="p">[</span><span class="s1">&#39;qualifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;(^\w+)&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">qualifiers</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qualifiers</span><span class="p">[</span><span class="s1">&#39;qualifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;(\w+$)&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">qualifier_values</span> <span class="o">=</span> <span class="n">qualifiers</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_VALUE</span><span class="p">)</span>
        <span class="n">qualifier_columns</span> <span class="o">=</span> <span class="n">qualifier_values</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>

        <span class="n">qualifiers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">qualifiers</span><span class="p">,</span> <span class="n">qualifier_values</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">merge_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_USER_CLASS</span><span class="p">,</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_PURPOSE</span><span class="p">,</span>
            <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_DEMAND_MODE_TYPE</span><span class="p">,</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_DEMAND_MODE</span><span class="p">,</span>
            <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_SUPPLY_MODE</span><span class="p">,</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_COLUMN_WEIGHT_NAME</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">qualifiers</span> <span class="o">=</span> <span class="n">qualifiers</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">merge_cols</span><span class="p">)[</span><span class="n">qualifier_columns</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">qualifiers</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">merge_cols</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="c1">#Check for required logarithmic attributes and that they are all non-zero and positive</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights_df</span><span class="p">[</span><span class="n">weights_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">LOGARITHMIC_GROWTH_MODEL</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_LOG_BASE</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">weights_df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">weights_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">LOGARITHMIC_GROWTH_MODEL</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">weights_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_LOG_BASE</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights_df</span><span class="p">[</span><span class="n">weights_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">LOGISTIC_GROWTH_MODEL</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_LOGISTIC_MID</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_LOGISTIC_MAX</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">weights_df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">weights_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">LOGISTIC_GROWTH_MODEL</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">weights_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_LOGISTIC_MAX</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">weights_df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">weights_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">LOGISTIC_GROWTH_MODEL</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">weights_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_GROWTH_LOGISTIC_MID</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">weights_df</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">write_configuration</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the configuration parameters to function as a record with the output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">SafeConfigParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;input_demand_dir&#39;</span><span class="p">,</span>              <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_DEMAND_DIR</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;input_network_dir&#39;</span><span class="p">,</span>             <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_NETWORK_ARCHIVE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;input_weights&#39;</span><span class="p">,</span>                 <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_WEIGHTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;input_functions&#39;</span><span class="p">,</span>           <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;run_config&#39;</span><span class="p">,</span>                    <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FILE</span><span class="p">)</span>


        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;max_iterations&#39;</span><span class="p">,</span>                <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_ITERATIONS</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;max_pf_iterations&#39;</span><span class="p">,</span>                <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_PF_ITERATIONS</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;simulation&#39;</span><span class="p">,</span>                    <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIMULATION</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;output_dir&#39;</span><span class="p">,</span>                    <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_DIR</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;output_passenger_trajectories&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;output_pathset_per_sim_iter&#39;</span><span class="p">,</span>   <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;create_skims&#39;</span><span class="p">,</span>                  <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CREATE_SKIMS</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;skim_start_time&#39;</span><span class="p">,</span>               <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIM_START_TIME</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;skim_end_time&#39;</span><span class="p">,</span>                 <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIM_END_TIME</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;capacity_constraint&#39;</span><span class="p">,</span>           <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CAPACITY_CONSTRAINT</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;skip_person_ids&#39;</span><span class="p">,</span>               <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;trace_ids&#39;</span><span class="p">,</span>                     <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;debug_trace_only&#39;</span><span class="p">,</span>              <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_TRACE_ONLY</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;debug_num_trips&#39;</span><span class="p">,</span>               <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;debug_output_columns&#39;</span><span class="p">,</span>          <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;fare_zone_symmetry&#39;</span><span class="p">,</span>            <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">FARE_ZONE_SYMMETRY</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;prepend_route_id_to_trip_id&#39;</span><span class="p">,</span>   <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PREPEND_ROUTE_ID_TO_TRIP_ID</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;number_of_processes&#39;</span><span class="p">,</span>           <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;bump_buffer&#39;</span><span class="p">,</span>                   <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_BUFFER</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fasttrips&#39;</span><span class="p">,</span><span class="s1">&#39;bump_one_at_a_time&#39;</span><span class="p">,</span>            <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="c1">#pathfinding</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;max_num_paths&#39;</span><span class="p">,</span>               <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_NUM_PATHS</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;min_path_probability&#39;</span><span class="p">,</span>        <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MIN_PATH_PROBABILITY</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;min_transfer_penalty&#39;</span><span class="p">,</span>        <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">MIN_TRANSFER_PENALTY</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;overlap_chunk_size&#39;</span><span class="p">,</span>          <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_CHUNK_SIZE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;overlap_scale_parameter&#39;</span><span class="p">,</span>     <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_SCALE_PARAMETER</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;overlap_split_transit&#39;</span><span class="p">,</span>       <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_SPLIT_TRANSIT</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;overlap_variable&#39;</span><span class="p">,</span>            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">OVERLAP_VARIABLE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;pathfinding_type&#39;</span><span class="p">,</span>            <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;pathweights_fixed_width&#39;</span><span class="p">,</span>     <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">WEIGHTS_FIXED_WIDTH</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;stochastic_dispersion&#39;</span><span class="p">,</span>       <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;utils_conversion_factor&#39;</span><span class="p">,</span>     <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">UTILS_CONVERSION</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;stochastic_max_stop_process_count&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_MAX_STOP_PROCESS_COUNT</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;stochastic_pathset_size&#39;</span><span class="p">,</span>     <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_PATHSET_SIZE</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;time_window&#39;</span><span class="p">,</span>                 <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TIME_WINDOW</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;transfer_fare_ignore_pathfinding&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHFINDING</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;transfer_fare_ignore_pathenum&#39;</span><span class="p">,</span>    <span class="s1">&#39;True&#39;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHENUM</span> <span class="k">else</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;user_class_function&#39;</span><span class="p">,</span>         <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">USER_CLASS_FUNCTION</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;arrive_late_allowed_min&#39;</span><span class="p">,</span>     <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">ARRIVE_LATE_ALLOWED_MIN</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pathfinding&#39;</span><span class="p">,</span><span class="s1">&#39;depart_early_allowed_min&#39;</span><span class="p">,</span>    <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">DEPART_EARLY_ALLOWED_MIN</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>

        <span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_OUTPUT_FILE</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">initialize_fasttrips_extension</span><span class="p">(</span><span class="n">process_number</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">stop_times_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the C++ fasttrips extension by passing it the network supply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing fasttrips extension for process number </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">process_number</span><span class="p">)</span>

        <span class="c1"># this may not be set yet if it is iter1</span>
        <span class="n">overcap_col</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MSA_RESULTS</span><span class="p">:</span>
            <span class="n">overcap_col</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_MSA_OVERCAP</span>

        <span class="k">if</span> <span class="n">overcap_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">stop_times_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">stop_times_df</span><span class="p">[</span><span class="n">overcap_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;initialize_fasttrips_extension() overcap sum: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stop_times_df</span><span class="p">[</span><span class="n">overcap_col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;initialize_fasttrips_extension() STOPTIMES_COLUMN_DEPARTURE_TIME_MIN len: </span><span class="si">%d</span><span class="s2"> mean: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> \
                              <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stop_times_df</span><span class="p">),</span> <span class="n">stop_times_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME_MIN</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>

        <span class="n">_fasttrips</span><span class="o">.</span><span class="n">initialize_supply</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">process_number</span><span class="p">,</span>
                                     <span class="n">stop_times_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span>
                                     <span class="n">stop_times_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME_MIN</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME_MIN</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_SHAPE_DIST_TRAVELED</span><span class="p">,</span>
                                                    <span class="n">overcap_col</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">))</span>

        <span class="n">_fasttrips</span><span class="o">.</span><span class="n">initialize_parameters</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TIME_WINDOW</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_BUFFER</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">UTILS_CONVERSION</span><span class="p">,</span>
                                         <span class="n">PathSet</span><span class="o">.</span><span class="n">DEPART_EARLY_ALLOWED_MIN</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span>
                                         <span class="n">PathSet</span><span class="o">.</span><span class="n">ARRIVE_LATE_ALLOWED_MIN</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_PATHSET_SIZE</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_MAX_STOP_PROCESS_COUNT</span><span class="p">,</span>
                                         <span class="mi">1</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHFINDING</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="mi">1</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRANSFER_FARE_IGNORE_PATHENUM</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_NUM_PATHS</span><span class="p">,</span>
                                         <span class="n">Assignment</span><span class="o">.</span><span class="n">MIN_PATH_PROBABILITY</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_fasttrips_bump_wait</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the bump wait information to the fasttrips extension</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># send a clear message?</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">_fasttrips</span><span class="o">.</span><span class="n">set_bump_wait</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                               <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                               <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                 <span class="n">bump_wait_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME_MIN</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">write_vehicle_trips</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">,</span>                             <span class="c1"># we&#39;ll add</span>
                   <span class="s2">&quot;pathfinding_iteration&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;simulation_iteration&quot;</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_DIRECTION_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_SERVICE_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_ROUTE_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME_MIN</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME_MIN</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRAVEL_TIME_SEC</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DWELL_TIME_SEC</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">VEHICLES_COLUMN_TOTAL_CAPACITY</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_STANDEES</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_FRICTION</span><span class="p">,</span>
                   <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">,</span>
                   <span class="c1"># Trip.SIM_COL_VEH_MSA_BOARDS,</span>
                   <span class="c1"># Trip.SIM_COL_VEH_MSA_ALIGHTS,</span>
                   <span class="c1"># Trip.SIM_COL_VEH_MSA_ONBOARD,</span>
                   <span class="c1"># Trip.SIM_COL_VEH_MSA_STANDEES,</span>
                   <span class="c1"># Trip.SIM_COL_VEH_MSA_FRICTION,</span>
                   <span class="c1"># Trip.SIM_COL_VEH_MSA_OVERCAP</span>
                   <span class="p">]</span>

        <span class="c1"># these may not be in there since they&#39;re optional</span>
        <span class="k">for</span> <span class="n">optional_col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_DIRECTION_ID</span><span class="p">,</span>
                             <span class="n">Trip</span><span class="o">.</span><span class="n">VEHICLES_COLUMN_TOTAL_CAPACITY</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">optional_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">veh_trips_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">optional_col</span><span class="p">)</span>

        <span class="n">veh_trips_df</span><span class="p">[</span>            <span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">veh_trips_df</span><span class="p">[</span><span class="s2">&quot;pathfinding_iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathfinding_iteration</span>
        <span class="n">veh_trips_df</span><span class="p">[</span> <span class="s2">&quot;simulation_iteration&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">simulation_iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span> <span class="s2">&quot;veh_trips_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;veh_trips.csv&quot;</span><span class="p">),</span>
                             <span class="n">append</span><span class="o">=</span><span class="p">(</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">pathfinding_iteration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">veh_trips_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;iteration&quot;</span><span class="p">,</span><span class="s2">&quot;pathfinding_iteration&quot;</span><span class="p">,</span><span class="s2">&quot;simulation_iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">merge_pathsets</span><span class="p">(</span><span class="n">pathfind_trip_list_df</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge the given new pathset paths and links into the existing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merge_pathsets():     pathset_paths_df len=</span><span class="si">%d</span><span class="s2"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span>    <span class="n">pathset_paths_df</span><span class="p">),</span>     <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merge_pathsets(): new_pathset_paths_df len=</span><span class="si">%d</span><span class="s2"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">),</span> <span class="n">new_pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merge_pathsets() dtypes=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merge_pathsets():     pathset_links_df len=</span><span class="si">%d</span><span class="s2"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span>    <span class="n">pathset_links_df</span><span class="p">),</span>     <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merge_pathsets(): new_pathset_links_df len=</span><span class="si">%d</span><span class="s2"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_pathset_links_df</span><span class="p">),</span> <span class="n">new_pathset_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merge_pathsets() dtypes=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>


        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merge_pathsets():     pathfind_trip_list_df len=</span><span class="si">%d</span><span class="s2"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span>    <span class="n">pathfind_trip_list_df</span><span class="p">),</span>     <span class="n">pathfind_trip_list_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="c1"># TODO: This might be inefficient...</span>

        <span class="c1"># filter out the new pathset person trips from pathset_paths_df</span>
        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">pathset_paths_df</span><span class="p">,</span>
                                        <span class="n">right</span>    <span class="o">=</span><span class="n">pathfind_trip_list_df</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">]],</span>
                                        <span class="n">how</span>      <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                        <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_paths_df</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;left_only&quot;</span><span class="p">]</span>
        <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Filtered to </span><span class="si">%d</span><span class="s2"> pathset_paths_df rows&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">))</span>
        <span class="c1"># TODO: error prone, make this cleaner with where it&#39;s initialized elsewhere</span>
        <span class="n">new_pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">),</span>
                                                                                  <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">new_pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># append</span>
        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_paths_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Concatenated so pathset_paths_df has </span><span class="si">%d</span><span class="s2"> rows&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">))</span>

        <span class="c1"># filter out the new pathset person trips from pathset_links_df</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
                                        <span class="n">right</span>    <span class="o">=</span><span class="n">pathfind_trip_list_df</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">]],</span>
                                        <span class="n">how</span>      <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                        <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;left_only&quot;</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Filtered to </span><span class="si">%d</span><span class="s2"> pathset_links_df rows&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">))</span>
        <span class="c1"># append</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Concatenated so pathset_links_df has </span><span class="si">%d</span><span class="s2"> rows&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">))</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merge_pathsets():     pathset_paths_df len=</span><span class="si">%d</span><span class="s2"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">tail=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">),</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(),</span><span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merge_pathsets():     pathset_links_df len=</span><span class="si">%d</span><span class="s2"> head=</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">tail=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(),</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

        <span class="c1"># done with this</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">number_of_pathsets</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of passenger trips with pathsets and returns it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">]))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">assign_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">FT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the paths for the passengers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># clear any state</span>
        <span class="n">_fasttrips</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># write the initial load profile, iteration 0</span>
        <span class="n">veh_trips_df</span>     <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">get_full_trips</span><span class="p">()</span>
        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">last_chosen_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span>
        <span class="p">])</span>

        <span class="n">success_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span><span class="p">,</span>
            <span class="n">PathSet</span><span class="o">.</span><span class="n">SUCCESS_FLAG_COLUMN</span>
        <span class="p">])</span>

        <span class="n">bump_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span><span class="p">,</span>
            <span class="n">PathSet</span><span class="o">.</span><span class="n">BUMP_FLAG_COLUMN</span>
        <span class="p">])</span>

        <span class="n">success_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">SUCCESS_FLAG_COLUMN</span><span class="p">]</span> <span class="o">=</span> <span class="n">success_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">SUCCESS_FLAG_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">bump_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">BUMP_FLAG_COLUMN</span><span class="p">]</span> <span class="o">=</span> <span class="n">bump_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">BUMP_FLAG_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># write 0-iter vehicle trips</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">write_vehicle_trips</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_ITERATIONS</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">pathfinding_iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_PF_ITERATIONS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

                <span class="c1"># First pathfinding_iteration, find paths for everyone</span>
                <span class="k">if</span> <span class="n">pathfinding_iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Subsequent: just find paths for those without paths</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***************************** ITERATION </span><span class="si">%d</span><span class="s2"> PATHFINDING ITERATION </span><span class="si">%d</span><span class="s2"> **************************************&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">))</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span> <span class="o">==</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_READ_FILE</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pathfinding_iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading paths from file&quot;</span><span class="p">)</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_start</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;pathreading&quot;</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">read_passenger_pathsets</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">stops</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">modes_df</span><span class="p">,</span> <span class="n">include_asgn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">num_new_paths_found</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">number_of_pathsets</span><span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">)</span>

                    <span class="c1"># todo: what about subsequent iterations</span>
                    <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_start</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;pathfinding&quot;</span><span class="p">)</span>
                    <span class="n">num_new_paths_found</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">generate_pathsets</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">setup_passenger_pathsets</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">stops</span><span class="p">,</span>
                                                                                                          <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">trip_id_df</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">trips_df</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">modes_df</span><span class="p">,</span>
                                                                                                          <span class="n">FT</span><span class="o">.</span><span class="n">transfers</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">tazs</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PREPEND_ROUTE_ID_TO_TRIP_ID</span><span class="p">)</span>
                    <span class="c1"># write pathfinding results to special PF results file</span>
                    <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                          <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                    <span class="c1"># write performance info right away in case we crash, quit, etc</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">write_pathfinding</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="p">((</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pathfinding_iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)))</span>

                <span class="c1"># If we found paths for everyone, excellent</span>
                <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span><span class="p">:</span>
                    <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">new_pathset_paths_df</span>
                    <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">new_pathset_links_df</span>
                <span class="c1"># Otherwise, merge with those for whom we already have</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">merge_pathsets</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">new_pathset_paths_df</span><span class="p">,</span> <span class="n">new_pathset_links_df</span><span class="p">)</span>

                <span class="c1"># if we have new paths, simulate them</span>
                <span class="k">if</span> <span class="n">num_new_paths_found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">merge_prior_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">success_df</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIMULATION</span><span class="p">:</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***************************** ITERATION </span><span class="si">%d</span><span class="s2"> PATHFINDING ITERATION </span><span class="si">%d</span><span class="s2"> *** SIMULATING ***********************&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">))</span>
                        <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_start</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;simulating&quot;</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span> <span class="o">=</span> \
                            <span class="n">Assignment</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if we&#39;re not simulating, we can still calculate costs and choose paths</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***************************** ITERATION </span><span class="si">%d</span><span class="s2"> PATHFINDING ITERATION </span><span class="si">%d</span><span class="s2"> *****CHOOSING PATHS WITHOUT SIMULATING&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">))</span>
                        <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_start</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;choosing_without_simulating&quot;</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> \
                            <span class="n">Assignment</span><span class="o">.</span><span class="n">choose_paths_without_simulation</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

                <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_start</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;output_per_pathfinding_iteration&quot;</span><span class="p">)</span>

                <span class="c1"># Set new schedule</span>
                <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">stop_times_df</span> <span class="o">=</span> <span class="n">veh_trips_df</span>

                <span class="c1"># todo: pass back correct simulation iteration?</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">write_vehicle_trips</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="s2">&quot;final&quot;</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span><span class="p">:</span>
                    <span class="n">PathSet</span><span class="o">.</span><span class="n">write_path_times</span><span class="p">(</span><span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">output_dir</span><span class="p">)</span>

                <span class="c1"># capacity gap stuff</span>
                <span class="n">num_paths_found</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">number_of_pathsets</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">)</span>
                <span class="n">num_bumped_passengers</span> <span class="o">=</span> <span class="n">num_paths_found</span> <span class="o">-</span> <span class="n">num_passengers_arrived</span>


                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Length of trip list:       </span><span class="si">%10d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">))</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Number of pathsets found:  </span><span class="si">%10d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">num_paths_found</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  ARRIVED PASSENGERS:        </span><span class="si">%10d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">num_passengers_arrived</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  MISSED PASSENGERS:         </span><span class="si">%10d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">num_bumped_passengers</span><span class="p">)</span>


                <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_end</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># if no new paths found, pathfinding_iteration loop is done</span>
                <span class="k">if</span> <span class="n">num_new_paths_found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">success_df</span><span class="p">,</span> <span class="n">bump_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">save_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">success_df</span><span class="p">,</span> <span class="n">bump_df</span><span class="p">)</span>
            <span class="n">new_choices</span><span class="p">,</span> <span class="n">last_chosen_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">compare_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">last_chosen_df</span><span class="p">)</span>
            <span class="n">capacity_gap</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">new_choices</span> <span class="o">+</span> <span class="n">num_bumped_passengers</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">)</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;###OUTER LOOP: Iteration </span><span class="si">{}</span><span class="s2">###&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  CAPACITY GAP:              </span><span class="si">%10.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">capacity_gap</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  NEW CHOICE FROM PRIOR:     </span><span class="si">%10d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_choices</span><span class="p">)</span>


            <span class="n">success_df</span><span class="p">,</span> <span class="n">bump_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">save_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">success_df</span><span class="p">,</span> <span class="n">bump_df</span><span class="p">)</span>
            <span class="n">new_choices</span><span class="p">,</span> <span class="n">last_chosen_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">compare_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">last_chosen_df</span><span class="p">)</span>
            <span class="n">capacity_gap</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">new_choices</span> <span class="o">+</span> <span class="n">num_bumped_passengers</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">)</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;###OUTER LOOP: Iteration </span><span class="si">{}</span><span class="s2">###&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  CAPACITY GAP:              </span><span class="si">%10.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">capacity_gap</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  NEW CHOICE FROM PRIOR:     </span><span class="si">%10d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_choices</span><span class="p">)</span>


            <span class="n">success_df</span><span class="p">,</span> <span class="n">bump_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">save_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">success_df</span><span class="p">,</span> <span class="n">bump_df</span><span class="p">)</span>
            <span class="n">new_choices</span><span class="p">,</span> <span class="n">last_chosen_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">compare_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">last_chosen_df</span><span class="p">)</span>
            <span class="n">capacity_gap</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">new_choices</span> <span class="o">+</span> <span class="n">num_bumped_passengers</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">)</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;###OUTER LOOP: Iteration </span><span class="si">{}</span><span class="s2">###&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  CAPACITY GAP:              </span><span class="si">%10.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">capacity_gap</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  NEW CHOICE FROM PRIOR:     </span><span class="si">%10d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_choices</span><span class="p">)</span>


            <span class="c1"># end condition for iterations loop</span>
            <span class="k">if</span> <span class="n">capacity_gap</span> <span class="o">&lt;</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CONVERGENCE_GAP</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># end for loop</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;capacity_gap&quot;</span><span class="p">:</span> <span class="n">capacity_gap</span><span class="p">,</span>
                <span class="s2">&quot;paths_found&quot;</span><span class="p">:</span> <span class="n">num_paths_found</span><span class="p">,</span>
                <span class="s2">&quot;passengers_arrived&quot;</span><span class="p">:</span> <span class="n">num_passengers_arrived</span><span class="p">,</span>
                <span class="s2">&quot;passengers_missed&quot;</span><span class="p">:</span> <span class="n">num_bumped_passengers</span><span class="p">,</span>
                <span class="s2">&quot;passengers_demand&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">)</span> <span class="p">}</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compare_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">prior_choice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads in a pathset_path_df and the pathset_path_df of a prior iteration</span>
<span class="sd">        and returns the number of new choices made in the current iteration</span>
<span class="sd">        along with a simplified chosen df to use in the next iteration.</span>

<span class="sd">        :param pathset_paths_df: Current iteration of Pathset_Paths_DF</span>
<span class="sd">        :param prior_choice: Pathset_Paths_DF of a prior iteration.</span>
<span class="sd">        :return: new_choices_count: Total number of new choices in this iteration</span>
<span class="sd">                                    compared to the input prior choice df.</span>
<span class="sd">                 chosen: Simplified DF of &#39;person_id&#39;, &#39;person_trip_id_num&#39;, and &#39;description&#39;</span>
<span class="sd">                         that can be used in subsequent invocations of this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">chosen</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">)[</span>
            <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">match_choices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">prior_choice</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

        <span class="n">new_choices_count</span> <span class="o">=</span> <span class="n">chosen</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">match_choices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">new_choices_count</span><span class="p">,</span> <span class="n">chosen</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">success_df</span><span class="p">,</span> <span class="n">bump_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an updated count of successfully chosen paths and</span>
<span class="sd">        paths that were bumped for each user.</span>
<span class="sd">        :param pathset_paths_df: Current iteration of pathset_paths_df after simulation.</span>
<span class="sd">        :param success_df: Count of chosen paths for each user across prior iterations</span>
<span class="sd">        :param bump_df: Count of bumped paths for each user across prior iterations</span>
<span class="sd">        :return:</span>
<span class="sd">            success_df: Updated count of chosen paths for each user across each iteration</span>
<span class="sd">            bump_df: Updated count of bumped paths for each user across each iteration</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">chosen</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">)</span>
        <span class="n">iter_bump_df</span> <span class="o">=</span> <span class="n">chosen</span><span class="p">[</span><span class="n">chosen</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">][</span>
            <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">iter_bump_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">BUMP_FLAG_COLUMN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">iter_bump_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bump_df</span><span class="p">,</span> <span class="n">iter_bump_df</span><span class="p">])</span>
        <span class="n">bump_df</span> <span class="o">=</span> <span class="n">iter_bump_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
                                        <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                        <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span><span class="p">])[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">BUMP_FLAG_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">iter_success_df</span> <span class="o">=</span> <span class="n">chosen</span><span class="p">[</span><span class="n">chosen</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span>
            <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">iter_success_df</span><span class="p">[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">SUCCESS_FLAG_COLUMN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">iter_success_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">success_df</span><span class="p">,</span> <span class="n">iter_success_df</span><span class="p">])</span>

        <span class="n">success_df</span> <span class="o">=</span> <span class="n">iter_success_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                              <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span><span class="p">]</span>
                                             <span class="p">)[</span><span class="n">PathSet</span><span class="o">.</span><span class="n">SUCCESS_FLAG_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">success_df</span><span class="p">,</span> <span class="n">bump_df</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">merge_prior_choices</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">flag_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Join success or bump flag count information onto a pathset_paths_df and pathset_links_df</span>
<span class="sd">        :param pathset_paths_df: Current iteration of pathset_paths_df.</span>
<span class="sd">        :param pathset_links_df: Current iteration of pathset_links_df</span>
<span class="sd">        :param flag_df: success or bump df</span>
<span class="sd">        :return: pathset_paths_df and pathset_links_df with additional flag column.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span><span class="p">((</span><span class="n">PathSet</span><span class="o">.</span><span class="n">SUCCESS_FLAG_COLUMN</span> <span class="ow">in</span> <span class="n">flag_df</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">PathSet</span><span class="o">.</span><span class="n">BUMP_FLAG_COLUMN</span> <span class="ow">in</span> <span class="n">flag_df</span><span class="p">))</span>

        <span class="n">flag_col</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">SUCCESS_FLAG_COLUMN</span> <span class="k">if</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">SUCCESS_FLAG_COLUMN</span> <span class="ow">in</span> <span class="n">flag_df</span> <span class="k">else</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">BUMP_FLAG_COLUMN</span>

        <span class="k">if</span> <span class="n">flag_col</span> <span class="ow">in</span> <span class="n">pathset_paths_df</span><span class="p">:</span>
            <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">flag_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flag_col</span> <span class="ow">in</span> <span class="n">pathset_links_df</span><span class="p">:</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">flag_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">flag_df</span><span class="p">,</span>
                                    <span class="n">on</span> <span class="o">=</span> <span class="p">[</span>
                                        <span class="n">Passenger</span><span class="o">.</span><span class="n">PERSONS_COLUMN_PERSON_ID</span><span class="p">,</span>
                                        <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                        <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_DESCRIPTION</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_paths_df</span><span class="p">[</span><span class="n">flag_col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">flag_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span><span class="n">pathset_paths_df</span><span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;trip_list_id_num&#39;</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span> <span class="n">flag_col</span><span class="p">,</span> <span class="p">]],</span>
                                    <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trip_list_id_num&#39;</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">filter_trip_list_to_not_arrived</span><span class="p">(</span><span class="n">trip_list_df</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter the given trip list to only those that have not arrived according to *pathset_paths_df*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;filter_trip_list_to_not_arrived(): trip_list_df len=</span><span class="si">%d</span><span class="s2"> head()=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_list_df</span><span class="p">),</span> <span class="n">trip_list_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;filter_trip_list_to_not_arrived(): pathset_paths_df len=</span><span class="si">%d</span><span class="s2"> head()=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">),</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;pathset_paths_df.dtypes&quot;</span><span class="p">)</span>

        <span class="c1"># filter to only the chosen paths</span>
        <span class="n">chosen_paths_df</span> <span class="o">=</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">,</span>
                                                <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]]</span>

        <span class="c1"># add chosen index</span>
        <span class="n">trip_list_df_to_return</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>  <span class="o">=</span><span class="n">trip_list_df</span><span class="p">,</span>
                                              <span class="n">right</span> <span class="o">=</span><span class="n">chosen_paths_df</span><span class="p">,</span>
                                              <span class="n">how</span>   <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="c1"># use it to filter to null chosen</span>
        <span class="n">trip_list_df_to_return</span> <span class="o">=</span> <span class="n">trip_list_df_to_return</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">trip_list_df_to_return</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">])]</span>
        <span class="c1"># remove chosen column</span>
        <span class="n">trip_list_df_to_return</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;filter_trip_list_to_not_arrived(): trip_list_df_to_return len=</span><span class="si">%d</span><span class="s2"> head()=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trip_list_df_to_return</span><span class="p">),</span> <span class="n">trip_list_df_to_return</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">trip_list_df_to_return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generate_pathsets</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Figures out which person trips for whom to generate_pathsets, stored in :py:attr:`Passenger.pathfind_trip_list_df`</span>

<span class="sd">        Generates paths sets for those person trips using deterministic trip-based shortest path (TBSP) or</span>
<span class="sd">        stochastic trip-based hyperpath (TBHP).</span>

<span class="sd">        Returns the number of pathsets found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;**************************** GENERATING PATHS **********************************************************&quot;</span><span class="p">)</span>
        <span class="n">start_time</span>          <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">process_dict</span>        <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># workernum -&gt; {&quot;process&quot;:process, &quot;alive&quot;:alive bool, &quot;done&quot;:done bool, &quot;working_on&quot;:(person_id, trip_list_num)}</span>
        <span class="n">todo_queue</span>          <span class="o">=</span> <span class="kc">None</span>
        <span class="n">done_queue</span>          <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># We only need to do this once</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pathfinding_iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_TRACE_ONLY</span><span class="p">:</span>
                <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRACE</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span><span class="p">:</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Truncating trip list to </span><span class="si">%d</span><span class="s2"> trips&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span><span class="p">)</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_NUM_TRIPS</span><span class="p">]</span>

            <span class="c1"># Skip someone?</span>
            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SKIP_PERSON_IDS</span><span class="p">)]</span>

        <span class="c1"># these are the trips for which we&#39;ll find paths</span>
        <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span>

        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span><span class="p">:</span>
            <span class="c1"># we&#39;re starting over with empty vehicles</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">reset_onboard</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finding paths for trips for those that haven&#39;t arrived yet&quot;</span><span class="p">)</span>
            <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">filter_trip_list_to_not_arrived</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">)</span>

        <span class="n">est_paths_to_find</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finding pathsets for </span><span class="si">%d</span><span class="s2"> trips&quot;</span> <span class="o">%</span> <span class="n">est_paths_to_find</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">est_paths_to_find</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">info_freq</span>           <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">est_paths_to_find</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">info_freq</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">info_freq</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># info_freq = 1 # DEBUG CRASH</span>

        <span class="n">num_processes</span>       <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span>
        <span class="k">if</span>  <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_processes</span>   <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="c1"># it&#39;s not worth it unless each process does 3</span>
        <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="n">est_paths_to_find</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">num_processes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">est_paths_to_find</span><span class="o">//</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># this is probalby time consuming... put in a try block</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Setup multiprocessing processes</span>
            <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">todo_queue</span>      <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                <span class="n">done_queue</span>      <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">num_processes</span><span class="p">):</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting worker process </span><span class="si">%2d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">process_idx</span><span class="p">)</span>
                    <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;process&quot;</span><span class="p">:</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">find_trip_based_paths_process_worker</span><span class="p">,</span>
                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">process_idx</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_NETWORK_ARCHIVE</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">INPUT_DEMAND_DIR</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FILE</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="n">todo_queue</span><span class="p">,</span> <span class="n">done_queue</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)),</span>
                        <span class="s2">&quot;alive&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;done&quot;</span><span class="p">:</span><span class="kc">False</span>
                    <span class="p">}</span>
                    <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s2">&quot;process&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">initialize_fasttrips_extension</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

            <span class="c1"># process tasks or send tasks to workers for processing</span>
            <span class="n">num_paths_found_prev</span>  <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_paths_found_now</span>   <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_paths_sought</span>      <span class="o">=</span> <span class="mi">0</span>
            <span class="n">path_cols</span>             <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path_tuple</span> <span class="ow">in</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">pathfind_trip_list_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">path_dict</span>         <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">path_cols</span><span class="p">,</span> <span class="n">path_tuple</span><span class="p">)))</span>
                <span class="n">trip_list_id</span>      <span class="o">=</span> <span class="n">path_dict</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">]</span>
                <span class="n">person_id</span>         <span class="o">=</span> <span class="n">path_dict</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">]</span>
                <span class="n">person_trip_id</span>    <span class="o">=</span> <span class="n">path_dict</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">]</span>
                <span class="n">do_trace</span>          <span class="o">=</span> <span class="n">path_dict</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRACE</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_TRACE_ONLY</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_trace</span><span class="p">:</span> <span class="k">continue</span>

                <span class="c1"># first iteration -- create path objects</span>
                <span class="k">if</span> <span class="n">iteration</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">trip_pathset</span> <span class="o">=</span> <span class="n">PathSet</span><span class="p">(</span><span class="n">path_dict</span><span class="p">)</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">add_pathset</span><span class="p">(</span><span class="n">trip_list_id</span><span class="p">,</span> <span class="n">trip_pathset</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trip_pathset</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">get_pathset</span><span class="p">(</span><span class="n">trip_list_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">trip_pathset</span><span class="o">.</span><span class="n">goes_somewhere</span><span class="p">():</span> <span class="k">continue</span>

                <span class="c1"># find pathsets for everyone -- dwell times have changed</span>
                <span class="c1"># if iteration &gt; 1 and trip_list_id not in Assignment.bumped_trip_list_nums:</span>
                <span class="c1">#    num_paths_found_prev += 1</span>
                <span class="c1">#    continue</span>

                <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">todo_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="n">trip_pathset</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">do_trace</span><span class="p">:</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tracing assignment of person_id </span><span class="si">%s</span><span class="s2"> and trip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">person_id</span><span class="p">,</span> <span class="n">person_trip_id</span><span class="p">))</span>

                    <span class="c1"># do the work</span>
                    <span class="p">(</span><span class="n">pathdict</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span> <span class="o">=</span> \
                        <span class="n">Assignment</span><span class="o">.</span><span class="n">find_trip_based_pathset</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">trip_pathset</span><span class="p">,</span>
                                                           <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_TYPE_STOCHASTIC</span><span class="p">,</span>
                                                           <span class="n">trace</span><span class="o">=</span><span class="n">do_trace</span><span class="p">)</span>
                    <span class="n">num_paths_sought</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">trip_pathset</span><span class="o">.</span><span class="n">pathdict</span> <span class="o">=</span> <span class="n">pathdict</span>
                    <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">person_trip_id</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">trip_pathset</span><span class="o">.</span><span class="n">path_found</span><span class="p">():</span>
                        <span class="n">num_paths_found_now</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">num_paths_sought</span> <span class="o">%</span> <span class="n">info_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%6d</span><span class="s2"> paths sought, </span><span class="si">%6d</span><span class="s2"> paths found of </span><span class="si">%d</span><span class="s2"> paths total.  Time elapsed: </span><span class="si">%2d</span><span class="s2">h:</span><span class="si">%2d</span><span class="s2">m:</span><span class="si">%2d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                             <span class="n">num_paths_sought</span><span class="p">,</span> <span class="n">num_paths_found_now</span><span class="p">,</span> <span class="n">est_paths_to_find</span><span class="p">,</span>
                                             <span class="nb">int</span><span class="p">(</span> <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                             <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span><span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
                                             <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>

            <span class="c1"># multiprocessing follow-up</span>
            <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># we&#39;re done, let each process know</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">process_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">todo_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="p">)</span>

                <span class="c1"># get results</span>
                <span class="n">done_procs</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># where done means not alive</span>
                <span class="k">while</span> <span class="n">done_procs</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">process_dict</span><span class="p">):</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span>     <span class="o">=</span> <span class="n">done_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
                        <span class="n">worker_num</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># FastTripsLogger.debug(&quot;Received %s&quot; % str(result))</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;DONE&quot;</span><span class="p">:</span>
                            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received done from process </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">worker_num</span><span class="p">)</span>
                            <span class="n">process_dict</span><span class="p">[</span><span class="n">worker_num</span><span class="p">][</span><span class="s2">&quot;done&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STARTING&quot;</span><span class="p">:</span>
                            <span class="n">process_dict</span><span class="p">[</span><span class="n">worker_num</span><span class="p">][</span><span class="s2">&quot;working_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;COMPLETED&quot;</span><span class="p">:</span>
                            <span class="n">trip_list_id</span>    <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">pathset</span>         <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">get_pathset</span><span class="p">(</span><span class="n">trip_list_id</span><span class="p">)</span>
                            <span class="n">pathset</span><span class="o">.</span><span class="n">pathdict</span><span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                            <span class="n">perf_dict</span>       <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

                            <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span>

                            <span class="n">num_paths_sought</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">pathset</span><span class="o">.</span><span class="n">path_found</span><span class="p">():</span>
                                <span class="n">num_paths_found_now</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="k">if</span> <span class="n">num_paths_sought</span> <span class="o">%</span> <span class="n">info_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%6d</span><span class="s2"> paths sought, </span><span class="si">%6d</span><span class="s2"> paths found of </span><span class="si">%d</span><span class="s2"> paths total.  Time elapsed: </span><span class="si">%2d</span><span class="s2">h:</span><span class="si">%2d</span><span class="s2">m:</span><span class="si">%2d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                                     <span class="n">num_paths_sought</span><span class="p">,</span> <span class="n">num_paths_found_now</span><span class="p">,</span> <span class="n">est_paths_to_find</span><span class="p">,</span>
                                                     <span class="nb">int</span><span class="p">(</span> <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                                     <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span><span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
                                                     <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>

                            <span class="k">del</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">worker_num</span><span class="p">][</span><span class="s2">&quot;working_on&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unexpected done queue contents: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

                    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="c1"># This is normal</span>
                        <span class="k">pass</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Caught exception: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()))</span>
                        <span class="k">pass</span>

                    <span class="c1"># check if any processes are not alive</span>
                    <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">process_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s2">&quot;alive&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s2">&quot;process&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Process </span><span class="si">%d</span><span class="s2"> is not alive&quot;</span> <span class="o">%</span> <span class="n">process_idx</span><span class="p">)</span>
                            <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s2">&quot;alive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">done_procs</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># join up my processes</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">process_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s2">&quot;process&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                <span class="c1"># check if any processes crashed</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">process_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s2">&quot;done&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s2">&quot;working_on&quot;</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">]:</span>
                            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process </span><span class="si">%d</span><span class="s2"> appears to have crashed; it was working on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                                 <span class="p">(</span><span class="n">process_idx</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">process_dict</span><span class="p">[</span><span class="n">process_idx</span><span class="p">][</span><span class="s2">&quot;working_on&quot;</span><span class="p">])))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process </span><span class="si">%d</span><span class="s2"> appears to have crashed; see ft_debug_worker</span><span class="si">%02d</span><span class="s2">.log&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">process_idx</span><span class="p">,</span> <span class="n">process_idx</span><span class="p">))</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception caught: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_type</span><span class="p">))</span>
            <span class="n">error_lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">error_lines</span><span class="p">:</span> <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Terminating processes&quot;</span><span class="p">)</span>
            <span class="c1"># terminating my processes</span>
            <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="p">:</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># some other error</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">error_lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">error_lines</span><span class="p">:</span> <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished finding </span><span class="si">%6d</span><span class="s2"> passenger paths.  Time elapsed: </span><span class="si">%2d</span><span class="s2">h:</span><span class="si">%2d</span><span class="s2">m:</span><span class="si">%2d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                 <span class="n">num_paths_found_now</span><span class="p">,</span>
                                 <span class="nb">int</span><span class="p">(</span> <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                 <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span><span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
                                 <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">num_paths_found_now</span> <span class="o">+</span> <span class="n">num_paths_found_prev</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_trip_based_pathset</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform trip-based path set search.</span>

<span class="sd">        Will do so either backwards (destination to origin) if :py:attr:`PathSet.direction` is :py:attr:`PathSet.DIR_OUTBOUND`</span>
<span class="sd">        or forwards (origin to destination) if :py:attr:`PathSet.direction` is :py:attr:`PathSet.DIR_INBOUND`.</span>

<span class="sd">        Returns (pathdict,</span>
<span class="sd">                 performance_dict)</span>

<span class="sd">        Where pathdict maps {pathnum:{PATH_KEY_COST:cost, PATH_KEY_PROBABILITY:probability, PATH_KEY_STATES:[state list]}}</span>

<span class="sd">        Where performance_dict includes:</span>
<span class="sd">                 pathfinding return status,</span>
<span class="sd">                 number of label iterations,</span>
<span class="sd">                 max number of times a stop was processed,</span>
<span class="sd">                 seconds spent in labeling,</span>
<span class="sd">                 seconds spend in enumeration</span>

<span class="sd">        :param pathset:   the path to fill in</span>
<span class="sd">        :type  pathset:   a :py:class:`PathSet` instance</span>
<span class="sd">        :param hyperpath: pass True to use a stochastic hyperpath-finding algorithm, otherwise a deterministic shortest path</span>
<span class="sd">                          search algorithm will be use.</span>
<span class="sd">        :type  hyperpath: bool</span>
<span class="sd">        :param trace:     pass True if this path should be traced to the debug log</span>
<span class="sd">        :type  trace:     bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FastTripsLogger.debug(&quot;C++ extension start&quot;)</span>
        <span class="c1"># send it to the C++ extension</span>
        <span class="p">(</span><span class="n">ret_ints</span><span class="p">,</span> <span class="n">ret_doubles</span><span class="p">,</span> <span class="n">path_costs</span><span class="p">,</span> <span class="n">process_num</span><span class="p">,</span> <span class="n">pf_returnstatus</span><span class="p">,</span>
         <span class="n">label_iterations</span><span class="p">,</span> <span class="n">num_labeled_stops</span><span class="p">,</span> <span class="n">max_label_process_count</span><span class="p">,</span>
         <span class="n">ms_labeling</span><span class="p">,</span> <span class="n">ms_enumerating</span><span class="p">,</span>
         <span class="n">bytes_workingset</span><span class="p">,</span> <span class="n">bytes_privateusage</span><span class="p">,</span> <span class="n">mem_timestamp</span><span class="p">)</span> <span class="o">=</span> \
            <span class="n">_fasttrips</span><span class="o">.</span><span class="n">find_pathset</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">,</span>
                                 <span class="n">pathset</span><span class="o">.</span><span class="n">user_class</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">purpose</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">access_mode</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">transit_mode</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">egress_mode</span><span class="p">,</span>
                                 <span class="n">pathset</span><span class="o">.</span><span class="n">o_taz_num</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">d_taz_num</span><span class="p">,</span>
                                 <span class="mi">1</span> <span class="k">if</span> <span class="n">pathset</span><span class="o">.</span><span class="n">outbound</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">pref_time_min</span><span class="p">),</span> <span class="n">pathset</span><span class="o">.</span><span class="n">vot</span><span class="p">,</span>
                                 <span class="mi">1</span> <span class="k">if</span> <span class="n">trace</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># FastTripsLogger.debug(&quot;C++ extension complete&quot;)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Finished finding path for person </span><span class="si">%s</span><span class="s2"> trip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">))</span>
        <span class="n">pathdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">row_num</span>  <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">path_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">path_costs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_COST</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_FARE</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_PROBABILITY</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_INIT_COST</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_INIT_FARE</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">path_costs</span><span class="p">[</span><span class="n">path_num</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
            <span class="c1"># List of (stop_id, stop_state)</span>
            <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_STATES</span>     <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># print &quot;path_num %d&quot; % path_num</span>

            <span class="c1"># while we have unprocessed rows and the row is still relevant for this path_num</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">row_num</span> <span class="o">&lt;</span> <span class="n">ret_ints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">path_num</span><span class="p">):</span>
                <span class="c1"># print row_num</span>

                <span class="n">mode</span> <span class="o">=</span> <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># todo</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_ACCESS</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">101</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_EGRESS</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">102</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_TRANSFER</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">103</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">MODE_GENERIC_TRANSIT_NUM</span>

                <span class="k">if</span> <span class="n">hyperpath</span><span class="p">:</span>
                    <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_STATES</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>                                                          <span class="c1"># label,</span>
                        <span class="n">Assignment</span><span class="o">.</span><span class="n">NETWORK_BUILD_DATE_START_TIME</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span>  <span class="c1"># departure/arrival time</span>
                        <span class="n">mode</span><span class="p">,</span>                                                                            <span class="c1"># departure/arrival mode</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                                             <span class="c1"># trip id</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>                                                             <span class="c1"># successor/predecessor</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>                                                             <span class="c1"># sequence</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>                                                             <span class="c1"># sequence succ/pred</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span>                              <span class="c1"># link time</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                                          <span class="c1"># link fare</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>                                                          <span class="c1"># link cost</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>                                                          <span class="c1"># link distance</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>                                                          <span class="c1"># cost</span>
                        <span class="n">Assignment</span><span class="o">.</span><span class="n">NETWORK_BUILD_DATE_START_TIME</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>   <span class="c1"># arrival/departure time</span>
                    <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pathdict</span><span class="p">[</span><span class="n">path_num</span><span class="p">][</span><span class="n">PathSet</span><span class="o">.</span><span class="n">PATH_KEY_STATES</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span>                              <span class="c1"># label,</span>
                        <span class="n">Assignment</span><span class="o">.</span><span class="n">NETWORK_BUILD_DATE_START_TIME</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span>  <span class="c1"># departure/arrival time</span>
                        <span class="n">mode</span><span class="p">,</span>                                                                            <span class="c1"># departure/arrival mode</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                                             <span class="c1"># trip id</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>                                                             <span class="c1"># successor/predecessor</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>                                                             <span class="c1"># sequence</span>
                        <span class="n">ret_ints</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>                                                             <span class="c1"># sequence succ/pred</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span>                              <span class="c1"># link time</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                                          <span class="c1"># link fare</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">4</span><span class="p">]),</span>                              <span class="c1"># link cost</span>
                        <span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>                                                          <span class="c1"># link dist</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">6</span><span class="p">]),</span>                              <span class="c1"># cost</span>
                        <span class="n">Assignment</span><span class="o">.</span><span class="n">NETWORK_BUILD_DATE_START_TIME</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">row_num</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>   <span class="c1"># arrival/departure time</span>
                    <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">row_num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">perf_dict</span> <span class="o">=</span> <span class="p">{</span> \
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_PROCESS_NUM</span>           <span class="p">:</span> <span class="n">process_num</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_PATHFINDING_STATUS</span>    <span class="p">:</span> <span class="n">pf_returnstatus</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_LABEL_ITERATIONS</span>      <span class="p">:</span> <span class="n">label_iterations</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_NUM_LABELED_STOPS</span>     <span class="p">:</span> <span class="n">num_labeled_stops</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_MAX_STOP_PROCESS_COUNT</span><span class="p">:</span> <span class="n">max_label_process_count</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_TIME_LABELING_MS</span>      <span class="p">:</span> <span class="n">ms_labeling</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_TIME_ENUMERATING_MS</span>   <span class="p">:</span> <span class="n">ms_enumerating</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_TRACED</span>                <span class="p">:</span> <span class="n">trace</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_WORKING_SET_BYTES</span>     <span class="p">:</span> <span class="n">bytes_workingset</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_PRIVATE_USAGE_BYTES</span>   <span class="p">:</span> <span class="n">bytes_privateusage</span><span class="p">,</span>
            <span class="n">Performance</span><span class="o">.</span><span class="n">PERFORMANCE_PF_COL_MEM_TIMESTAMP</span>         <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">mem_timestamp</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pathdict</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_passenger_vehicle_times</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">,</span> <span class="n">is_skimming</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a dataframe of passenger links and a dataframe of vehicle trip links, adds two new columns to the passenger links for board and alight time.</span>

<span class="sd">        - Takes the trip links of pathset_links_df (columns: person_id, trip_list_id_num, pathnum, linkmode, trip_id_num, A_id_num, B_id_num, A_seq, B_seq, pf_A_time, pf_B_time, pf_linktime, A_id, B_id, trip_id)</span>
<span class="sd">        - Joins with vehicle trips on trip id num, A_id, A_seq to add:</span>
<span class="sd">          * board time   (Assignment.SIM_COL_PAX_BOARD_TIME)</span>
<span class="sd">          * overcap      (Assignment.SIM_COL_PAX_OVERCAP)</span>
<span class="sd">          * overcap_frac (Assignment.SIM_COL_PAX_OVERCAP_FRAC)</span>
<span class="sd">        - Joins with vehicle trips on trip id num, B_id, B_seq to add:</span>
<span class="sd">          * alight time (Assignment.SIM_COL_PAX_ALIGHT_TIME)</span>

<span class="sd">        Returns the same dataframe but with four additional columns (replacing them if they&#39;re already there).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;find_passenger_vehicle_times(): input pathset_links_df len=</span><span class="si">%d</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRACE</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP_FRAC</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP_FRAC</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># FastTripsLogger.debug(&quot;pathset_links_df:\n%s\n&quot; % pathset_links_df.head().to_string())</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;veh_trips_df:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">veh_trips_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

        <span class="n">veh_trip_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME</span><span class="p">,</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">,</span>                <span class="c1"># TODO: what about msa_overcap?</span>
                         <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span><span class="p">]</span>

        <span class="c1"># this one may not be here -- it&#39;s only present during capacity stuff</span>
        <span class="k">if</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">veh_trip_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span><span class="p">)</span>

        <span class="c1"># This is a little long winded, but it cuts down on memory dramatically, but only copying</span>
        <span class="c1"># what is actually needed during the merges.</span>
        <span class="n">intermediate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">get_id_columns</span><span class="p">(</span><span class="n">is_skimming</span><span class="p">)</span> <span class="o">+</span>
                                                      <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="s1">&#39;A_id&#39;</span><span class="p">,</span> <span class="s1">&#39;A_seq&#39;</span><span class="p">,</span>
                                                       <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                       <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                                                       <span class="s1">&#39;B_id&#39;</span><span class="p">,</span> <span class="s1">&#39;B_seq&#39;</span><span class="p">]],</span>
                                <span class="n">right</span><span class="o">=</span><span class="n">veh_trips_df</span><span class="p">[</span><span class="n">veh_trip_cols</span><span class="p">],</span>
                                <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="s1">&#39;A_id&#39;</span><span class="p">,</span> <span class="s1">&#39;A_seq&#39;</span><span class="p">],</span>
                                <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                                          <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                                          <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
                                <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

        <span class="n">intermediate</span> <span class="o">=</span> <span class="n">intermediate</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                                                  <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                                  <span class="s1">&#39;A_id&#39;</span><span class="p">,</span> <span class="s1">&#39;A_seq&#39;</span><span class="p">])</span>

        <span class="n">intermediate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">intermediate</span><span class="p">,</span>
                                <span class="n">right</span><span class="o">=</span><span class="n">veh_trips_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME</span><span class="p">]],</span>
                                <span class="n">left_on</span> <span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span><span class="s1">&#39;B_id&#39;</span><span class="p">,</span><span class="s1">&#39;B_seq&#39;</span><span class="p">],</span>
                                <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                                          <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                                          <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
                                <span class="n">how</span>     <span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,)</span>

        <span class="n">intermediate</span> <span class="o">=</span> <span class="n">intermediate</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                                                  <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
                                                  <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                                  <span class="s1">&#39;B_id&#39;</span><span class="p">,</span><span class="s1">&#39;B_seq&#39;</span><span class="p">])</span>

        <span class="n">intermediate</span> <span class="o">=</span> <span class="n">intermediate</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME</span><span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">,</span>   <span class="c1"># transit vehicle depart time (at A) = board time for pax</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">,</span>  <span class="c1"># transit vehicle arrive time (at B) = alight time for pax</span>
        <span class="p">})</span>

        <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;find_passenger_vehicle_times(): output pathset_links_df len=</span><span class="si">%d</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRACE</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">intermediate</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">Passenger</span><span class="o">.</span><span class="n">get_id_columns</span><span class="p">(</span><span class="n">is_skimming</span><span class="p">)</span> <span class="o">+</span>
                                                           <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">put_passengers_on_vehicles</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Puts the chosen passenger trips specified in pathset_links_df onto the transit vehicle trips specified by veh_trip_df.</span>

<span class="sd">        Returns veh_trips_df but with updated columns</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_BOARDS`</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_ALIGHTS`</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_ONBOARD`</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_OVERCAP`</span>
<span class="sd">          - :py:attr:`Trip.SIM_COL_VEH_OVERCAP_FRAC`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># drop these -- we&#39;ll set them</span>
        <span class="k">if</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">veh_trips_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">,</span>
                               <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">,</span>
                               <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">veh_trips_df_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">)</span>

        <span class="n">passengers_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">transit_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># only care about trips</span>
        <span class="c1">#passengers_df = passengers_df.loc[passengers_df[Passenger.PF_COL_ROUTE_ID].notnull()]</span>

        <span class="c1"># Group to boards by counting trip_list_id_nums for a (trip_id, A_id as stop_id)</span>
        <span class="n">passenger_trips_boards</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">passengers_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span>  <span class="c1"># unbumped passengers</span>
                                                   <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="s1">&#39;A_id_num&#39;</span><span class="p">,</span><span class="s1">&#39;A_seq&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="s1">&#39;A_id_num&#39;</span><span class="p">,</span><span class="s1">&#39;A_seq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">passenger_trips_boards</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                              <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">,</span>
                                              <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">]</span>

        <span class="c1"># And alights by counting path_ids for a (trip_id, B_id as stop_id)</span>
        <span class="n">passenger_trips_alights</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">passengers_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span>
                                                    <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span>
                                                     <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="s1">&#39;B_id_num&#39;</span><span class="p">,</span><span class="s1">&#39;B_seq&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="s1">&#39;B_id_num&#39;</span><span class="p">,</span><span class="s1">&#39;B_seq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">passenger_trips_alights</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                               <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">,</span>
                                               <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">]</span>

        <span class="c1"># Join them to the transit vehicle trips so we can put people on vehicles (boards)</span>
        <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>        <span class="o">=</span> <span class="n">veh_trips_df</span><span class="p">,</span>
                                     <span class="n">right</span>       <span class="o">=</span> <span class="n">passenger_trips_boards</span><span class="p">,</span>
                                     <span class="n">left_on</span>     <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
                                     <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">how</span>         <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">:</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="c1"># Join for alights</span>
        <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>        <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">,</span>
                                     <span class="n">right</span>       <span class="o">=</span> <span class="n">passenger_trips_alights</span><span class="p">,</span>
                                    <span class="n">left_on</span>      <span class="o">=</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
                                    <span class="n">right_index</span>  <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">how</span>          <span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">:</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># replace has weird behaviour as of now, so we need a hack to take care of the new behaviour of fill in</span>
        <span class="c1"># TimeDelta columns --&gt; https://github.com/pandas-dev/pandas/issues/29024</span>
        <span class="n">tdelta_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timedelta&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">tdelta_cols</span><span class="p">:</span>
            <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">tdelta_cols</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">veh_loaded_df</span><span class="p">)</span><span class="o">==</span><span class="n">veh_trips_df_len</span><span class="p">)</span>

        <span class="c1"># these are ints, not floats</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">]:</span>
            <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID_NUM</span><span class="p">,</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span>    <span class="p">]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span>    <span class="p">]</span> <span class="o">-</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span>    <span class="p">]</span>

        <span class="c1"># on board is the cumulative sum of boards - alights</span>
        <span class="n">trips_cumsum</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># replace with cumsum</span>
        <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>        <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">,</span>
                                     <span class="n">right</span>       <span class="o">=</span> <span class="n">trips_cumsum</span><span class="p">,</span>
                                     <span class="n">left_index</span>  <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">how</span>         <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">veh_loaded_df</span><span class="p">)</span><span class="o">==</span><span class="n">veh_trips_df_len</span><span class="p">)</span>
        <span class="c1"># print veh_trips_df.loc[5123368]</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># overcap = how many people are problematic, or onboard-totalcap.  If negative, we have space.</span>
        <span class="c1"># overcap_frac = what percentage of boards are problematic</span>
        <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">]</span> <span class="o">-</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">VEHICLES_COLUMN_TOTAL_CAPACITY</span><span class="p">]</span>
        <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span> <span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span><span class="p">]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">]</span> <span class="o">/</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">]</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;veh_loaded_df with onboard&gt;0: (showing head)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
                              <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">veh_loaded_df</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">flag_missed_transfers</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given passenger pathset links with the vehicle board_time and alight_time attached to trip links,</span>
<span class="sd">        this method will add columns to determine if there are missed transfers.</span>

<span class="sd">        This works on all paths in the pathset rather than just the chosen paths because then we can choose</span>
<span class="sd">        a path without missed transfers.</span>

<span class="sd">        The following columns are used in pathset_links_df:</span>
<span class="sd">        * Passenger.TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM,</span>
<span class="sd">        * Passenger.PF_COL_PATH_NUM,</span>
<span class="sd">        * Passenger.PF_COL_LINK_NUM,</span>
<span class="sd">        * Assignment.SIM_COL_PAX_BOARD_TIME</span>
<span class="sd">        * Assignment.SIM_COL_PAX_ALIGHT_TIME</span>
<span class="sd">        * Passenger.PF_COL_PAX_B_TIME</span>

<span class="sd">        In particular, the following columns are added (or replaced if they&#39;re already there) to *pathset_links_df*:</span>

<span class="sd">        ======================================================= ==============================================================================</span>
<span class="sd">        Column Name                                             Column Description</span>
<span class="sd">        ======================================================= ==============================================================================</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_ALIGHT_DELAY_MIN`      Delay in alight_time from original pathfinding understanding of alight time</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_A_TIME`                New A time given the trip board/alight times for the trip links</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_B_TIME`                New B time given the trip board/alight times for the trip links</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_LINK_TIME`             New link time from B time - A time</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_WAIT_TIME`             New waittime given the trip board/alight times for the trip links</span>
<span class="sd">        :py:attr:`Assignment.SIM_COL_PAX_MISSED_XFER`           Is this link a missed xfer</span>
<span class="sd">        ======================================================= ==============================================================================</span>

<span class="sd">        The column, :py:attr:`AssignmentSIM_COL_PAX_MISSED_XFER`, is also added to *pathset_paths_df*.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Drop these, we&#39;ll set them again</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_WAIT_TIME</span><span class="p">,</span>
                                   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Set alight delay (min)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;flag_missed_transfers() pathset_links_df (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">),</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID</span><span class="p">]),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">((</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span><span class="o">-</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_B_TIME</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">))</span>

        <span class="c1">#: todo: is there a more elegant way to take care of this?  some trips have times after midnight so they&#39;re the next day</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">22</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">22</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">22</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">((</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span><span class="o">-</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_B_TIME</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">))</span>

        <span class="n">max_alight_delay_min</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Biggest alight_delay = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">max_alight_delay_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_alight_delay_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

        <span class="c1"># For trips, alight_time is the new B_time</span>
        <span class="c1"># Set A_time for links AFTER trip links by joining to next leg</span>
        <span class="n">next_trips</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[[</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">next_trips</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_trips</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">next_trips</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Add it to passenger trips.  Now A time is set for links after trip links (note this will never be a trip link)</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
                                        <span class="n">right</span><span class="o">=</span><span class="n">next_trips</span><span class="p">,</span>
                                        <span class="n">how</span>  <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                        <span class="n">on</span>   <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                               <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">])</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>

        <span class="c1"># Set the new B time for those links -- link time for access/egress/xfer is travel time since wait times are in trip links</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span> <span class="o">+</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_TIME</span><span class="p">]</span>
        <span class="c1"># For trip links, it&#39;s alight time</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">==</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_TRIP</span><span class="p">,</span>   <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_TIME</span><span class="p">]</span>
        <span class="c1"># For access links, it doesn&#39;t change from the original pathfinding result</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">==</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_ACCESS</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">==</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_ACCESS</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_B_TIME</span><span class="p">]</span>

        <span class="c1"># Now we only need to set the trip link&#39;s A time from the previous link&#39;s new_B_time</span>
        <span class="n">next_trips</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[[</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">next_trips</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_trips</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">next_trips</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">:</span><span class="s2">&quot;new_trip_A_time&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Add it to passenger trips.  Now new_trip_A_time is set for trip links</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>  <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
                                        <span class="n">right</span> <span class="o">=</span><span class="n">next_trips</span><span class="p">,</span>
                                        <span class="n">how</span>   <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                        <span class="n">on</span>    <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">])</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_MODE</span><span class="p">]</span><span class="o">==</span><span class="n">PathSet</span><span class="o">.</span><span class="n">STATE_MODE_TRIP</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s2">&quot;new_trip_A_time&quot;</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;new_trip_A_time&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span>

        <span class="c1">#: todo: is there a more elegant way to take care of this?  some trips have times after midnight so they&#39;re the next day</span>
        <span class="c1">#: if the linktime &gt; 22 hours then the trip time is probably off by a day, so it&#39;s right after midnight -- back it up</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span>

        <span class="c1">#: if the linktime &lt; -22 hours then the trip time is probably off by a day, so it&#39;s right before midnight -- back it up</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">22</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">22</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span>


        <span class="c1"># new wait time</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID</span><span class="p">]),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_WAIT_TIME</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">]</span>

        <span class="c1"># invalid trips have negative wait time</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_WAIT_TIME</span><span class="p">]</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># count how many are valid (sum of invalid = 0 for the trip list id + path)</span>
        <span class="n">pathset_links_df_grouped</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span> <span class="c1"># sort by this</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                             <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">])</span><span class="o">.</span><span class="n">aggregate</span><span class="p">({</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">:</span><span class="s2">&quot;sum&quot;</span> <span class="p">})</span>

        <span class="n">pathset_links_df_grouped</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pathset_links_df_grouped</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;          flag_missed_transfers found </span><span class="si">%d</span><span class="s2"> missed transfer trip legs for </span><span class="si">%d</span><span class="s2"> paths&quot;</span> <span class="o">%</span> \
                             <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                              <span class="n">pathset_links_df_grouped</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

        <span class="c1"># add missed_xfer to pathset_paths_df (replacing if it was there already)</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>  <span class="o">=</span><span class="n">pathset_paths_df</span><span class="p">,</span>
                                        <span class="n">right</span> <span class="o">=</span><span class="n">pathset_links_df_grouped</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_MISSED_XFER</span><span class="p">]],</span>
                                        <span class="n">how</span>   <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;flag_missed_transfers() pathset_paths_df (</span><span class="si">%d</span><span class="s2">):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">),</span> <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_passengers_on_vehicles_with_cap</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span>
                                             <span class="n">trips</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_loaded_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if we have boards on over-capacity vehicles.  Mark them and mark the boards.</span>

<span class="sd">        If :py:attr:`Assignment.CAPACITY_CONSTRAINT`, then bump off overcapacity passengers.</span>

<span class="sd">        The process is:</span>

<span class="sd">        1) Look at which vehicle links are over capacity, adding columns named :py:attr:`Trip.SIM_COL_VEH_OVERCAP`</span>
<span class="sd">           and py:attr:`Trip.SIM_COL_VEH_OVERCAP_FRAC` to *veh_loaded_df*</span>

<span class="sd">        2) Look at the stops where the first people board after we&#39;re at capacity (impossible boards) if any</span>

<span class="sd">        3) If :py:attr:`Assignment.BUMP_ONE_AT_A_TIME`, select the first such stop by arrival time</span>
<span class="sd">           Otherwise, select the first such stop for each vehicle trip</span>

<span class="sd">        4) Join these stops to pathset_links_df, so pathset_links_df now has column Assignment.SIM_COL_PAX_OVERCAP_FRAC</span>

<span class="sd">        5) If not :py:attr:`Assignment.CAPACITY_CONSTRAINT`, return (and drop the column named :py:attr:`Trip.SIM_COL_VEH_OVERCAP` from veh_loaded_df)</span>

<span class="sd">        6) Figure out which passenger trips are actually getting bumped.  Some people can get on at these stops, but not all, so let the first</span>
<span class="sd">           ones that arrive at the stop get on and filter to the ones we&#39;ll actually bump.  Update the column named :py:attr:`Assignmment.SIM_COL_PAX_BUMP_ITER`.</span>
<span class="sd">           If non-null, this represents the iteration the passenger got bumped.</span>

<span class="sd">        Return (chosen_paths_bumped, pathset_paths_df, pathset_links_df, veh_loaded_df)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># these are the relevant vehicle columns</span>
        <span class="n">vehicle_trip_debug_columns</span> <span class="o">=</span> <span class="p">[</span> \
            <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_ROUTE_ID</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_TRIP_ID</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">VEHICLES_COLUMN_TOTAL_CAPACITY</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_BOARDS</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ALIGHTS</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP_FRAC</span>
        <span class="p">]</span>
        <span class="c1"># these are the relevant pathset links colums</span>
        <span class="n">pax_links_debug_columns</span> <span class="o">=</span> <span class="p">[</span> \
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_TRIP_ID</span><span class="p">,</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">,</span>
            <span class="s2">&quot;A_id&quot;</span><span class="p">,</span><span class="s2">&quot;A_id_num&quot;</span><span class="p">,</span><span class="s2">&quot;A_seq&quot;</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP_FRAC</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">current_pf_iter</span>  <span class="o">=</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">pathfinding_iteration</span> <span class="o">+</span> <span class="n">iteration</span>
        <span class="n">current_sim_iter</span> <span class="o">=</span> <span class="s2">&quot;iter</span><span class="si">%.2f</span><span class="s2"> sim</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_pf_iter</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">)</span>

        <span class="c1"># this will involve looping</span>
        <span class="c1"># no one is bumped yet</span>
        <span class="n">bump_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP_FRAC</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="k">if</span> <span class="n">simulation_iteration</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># For those we just found paths for, no one is bumped or going on overcap vehicles yet</span>
            <span class="c1"># pathset_paths_df.loc[pathset_paths_df[Passenger.PF_COL_PF_ITERATION]==current_pf_iter, Assignment.SIM_COL_PAX_BUMP_ITER   ] = np.NaN</span>
            <span class="c1"># pathset_links_df.loc[pathset_links_df[Passenger.PF_COL_PF_ITERATION]==current_pf_iter, Assignment.SIM_COL_PAX_BUMP_ITER   ] = np.NaN</span>
            <span class="c1"># pathset_links_df.loc[pathset_links_df[Passenger.PF_COL_PF_ITERATION]==current_pf_iter, Assignment.SIM_COL_PAX_BOARD_STATE ] = np.NaN</span>

            <span class="c1"># anyone can be bumped, including those from previous pathfinding iters.  Otherwise, we wouldn&#39;t be able to ride to an earlier stop and bump them</span>
            <span class="n">pathset_paths_df</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">pathset_links_df</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">pathset_links_df</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="c1"># make sure BOARD_STATE and CHOSEN are categorical</span>
        <span class="n">pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_paths_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">BOARD_STATE_CATEGORICAL</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># loop for capacity constraint</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 5.1 Put passengers on transit vehicles.&quot;</span><span class="p">)</span>
            <span class="c1"># Put passengers on vehicles, updating the vehicle&#39;s boards, alights, onboard, overcap, overcap_frac</span>
            <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">put_passengers_on_vehicles</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_loaded_df</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;after putting passengers on vehicles, veh_loaded_df with onboard.head(30) = </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                  <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_ONBOARD</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">vehicle_trip_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CAPACITY_CONSTRAINT</span><span class="p">:</span>
                <span class="c1"># We can&#39;t do anything about capacity so assume everyone boarded</span>
                <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PF_ITERATION</span><span class="p">]</span><span class="o">==</span><span class="n">current_pf_iter</span><span class="p">)</span><span class="o">&amp;</span>
                                      <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_TRIP_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()),</span>
                                       <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;board_easy&quot;</span>
                <span class="k">break</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 5.2 Capacity constraints on transit vehicles.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bump_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;          Bumping one at a time? </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span> <span class="k">else</span> <span class="s2">&quot;false&quot;</span><span class="p">))</span>

            <span class="c1"># This will update board time, alight time, overcap, overcap_frac</span>
            <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_passenger_vehicle_times</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_loaded_df</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;pathset_links_df.head(20)=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">pax_links_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

            <span class="c1"># make sure BOARD_STATE and CHOSEN are categorical</span>
            <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">BOARD_STATE_CATEGORICAL</span><span class="p">)</span>

            <span class="c1"># CHOSEN: Everyone who can board easily, do so</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c1"># trip links only</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c1"># not already bumped</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">&gt;</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span><span class="o">&amp;</span>   <span class="c1"># chosen</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">),</span>                                 <span class="c1"># can board</span>
                                        <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;board_easy&quot;</span>
            <span class="c1"># CHOSEN:  Everyone who can squeeze in, do so</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c1"># trip links only</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c1"># not already bumped</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">&gt;</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span><span class="o">&amp;</span>   <span class="c1"># chosen</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">),</span>                                <span class="c1"># can barely board</span>
                                       <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;boarded&quot;</span>
            <span class="c1"># UNCHOSEN: paths that are overcap -- nope</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c1"># trip links only</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c1"># not already bumped</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span><span class="o">&amp;</span>  <span class="c1"># unchosen</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">),</span>                                <span class="c1"># overcap</span>
                                        <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bumped_unchosen&quot;</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c1"># trip links only</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c1"># not already bumped</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span><span class="o">&amp;</span>  <span class="c1"># unchosen</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_OVERCAP</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">),</span>                                <span class="c1"># overcap</span>
                                        <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span> <span class="p">]</span> <span class="o">=</span> <span class="n">bump_iter</span>

            <span class="c1"># For those trying to board overcap, choose the winners and losers</span>
            <span class="c1"># These are trips/stops over capacity</span>
            <span class="n">overcap_df</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load_passengers_on_vehicles_with_cap() </span><span class="si">%d</span><span class="s2"> vehicle trip/stops over capacity: (showing head)</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">overcap_df</span><span class="p">),</span> <span class="n">overcap_df</span><span class="p">[</span><span class="n">vehicle_trip_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

            <span class="c1"># If none, we&#39;re done</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overcap_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;          No over-capacity vehicles&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># 2) Look at the trip-stops where the *first people* board after we&#39;re at capacity (impossible boards) if any</span>
            <span class="n">bump_stops_df</span> <span class="o">=</span> <span class="n">overcap_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">])</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load_passengers_on_vehicles_with_cap() bump_stops_df iter=</span><span class="si">%d</span><span class="s2"> pf_iter=</span><span class="si">%d</span><span class="s2"> sim_iter=</span><span class="si">%d</span><span class="s2"> bump_iter=</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">bump_iter</span><span class="p">,</span>
                                   <span class="nb">len</span><span class="p">(</span><span class="n">bump_stops_df</span><span class="p">),</span> <span class="n">bump_stops_df</span><span class="p">[</span><span class="n">vehicle_trip_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span><span class="p">:</span>
                <span class="n">bump_stops_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">bump_stops_df</span> <span class="o">=</span> <span class="n">bump_stops_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;          Need to bump </span><span class="si">%d</span><span class="s2"> passengers from </span><span class="si">%d</span><span class="s2"> trip-stops&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bump_stops_df</span><span class="o">.</span><span class="n">overcap</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bump_stops_df</span><span class="p">)))</span>
            <span class="c1"># debug -- see the whole trip</span>
            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load_passengers_on_vehicles_with_cap() Trips with bump stops:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> \
                    <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                        <span class="n">left</span><span class="o">=</span><span class="n">veh_loaded_df</span><span class="p">[</span><span class="n">vehicle_trip_debug_columns</span><span class="p">],</span>
                        <span class="n">right</span><span class="o">=</span><span class="n">bump_stops_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">]],</span>
                        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

            <span class="c1"># make sure CHOSEN is categorical</span>
            <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span>     <span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_CATEGORIES</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># join CHOSEN pathset links to bump_stops_df; now passenger links boarding at a bump stop will have Trip.STOPTIMES_COLUMN_STOP_SEQUENCE set</span>
            <span class="n">bumpstop_boards</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>    <span class="o">=</span><span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>                               <span class="c1"># trip links only</span>
                                                                          <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span>                         <span class="c1"># not already bumped</span>
                                                                          <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_CHOSEN</span><span class="p">]</span><span class="o">&gt;</span><span class="n">Assignment</span><span class="o">.</span><span class="n">CHOSEN_NOT_CHOSEN_YET</span><span class="p">)</span> <span class="p">],</span> <span class="c1"># chosen</span>
                                           <span class="n">left_on</span> <span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="s2">&quot;A_seq&quot;</span><span class="p">],</span>
                                           <span class="n">right</span>   <span class="o">=</span><span class="n">bump_stops_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">]],</span>
                                           <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span>
                                           <span class="n">how</span>     <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="c1"># bump candidates: boarding at bump stops, chosen paths</span>
            <span class="n">bumpstop_boards</span> <span class="o">=</span> <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="c1"># board at bump_stops_df stop</span>
                                                   <span class="n">pax_links_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># bump off later arrivals, later trip_list_num</span>
            <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span> \
                <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span><span class="p">,</span> <span class="c1"># I think this is correct</span>
                <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                <span class="s2">&quot;A_seq&quot;</span><span class="p">,</span>
                <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">,</span>
                <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">],</span>
                <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># For each trip_id, stop_seq, stop_id, we want the first *overcap* rows</span>
            <span class="c1"># group to trip_id, stop_seq, stop_id and count off</span>
            <span class="n">bpb_count</span> <span class="o">=</span> <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span><span class="s2">&quot;A_seq&quot;</span><span class="p">,</span><span class="s2">&quot;A_id_num&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
            <span class="n">bpb_count</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bump_index&#39;</span>
            <span class="c1"># Add the bump index to our passenger-paths/stops</span>
            <span class="n">bumpstop_boards</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bumpstop_boards</span><span class="p">,</span> <span class="n">bpb_count</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># bump or board them</span>
            <span class="n">bumpstop_boards</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">([</span><span class="s2">&quot;boarded&quot;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">bumpstop_boards</span><span class="p">),</span> <span class="n">categories</span><span class="o">=</span><span class="n">Assignment</span><span class="o">.</span><span class="n">BOARD_STATE_CATEGORICAL</span><span class="p">)</span>
            <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="s2">&quot;bump_index&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">],</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bumped&quot;</span>  <span class="c1"># these folks got bumped</span>
            <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="s2">&quot;bump_index&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bumpstop_boards</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">SIM_COL_VEH_OVERCAP</span><span class="p">],</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">bump_iter</span>  <span class="c1"># these folks got bumped</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load_passengers_on_vehicles_with_cap() bumpstop_boards (</span><span class="si">%d</span><span class="s2"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bumpstop_boards</span><span class="p">),</span> <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

            <span class="c1"># filter to unique passengers/paths who got bumped</span>
            <span class="n">bump_paths</span> <span class="o">=</span> <span class="n">bumpstop_boards</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">bumpstop_boards</span><span class="p">[</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bumped&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_TRIP_LIST_ID_NUM</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">chosen_paths_bumped</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bump_paths</span><span class="p">)</span>

            <span class="c1"># figure when the wait time starts for the bump stops</span>
            <span class="n">new_bump_wait</span> <span class="o">=</span> <span class="n">bumpstop_boards</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="s2">&quot;A_seq&quot;</span><span class="p">,</span> <span class="s2">&quot;A_id_num&quot;</span><span class="p">,</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> \
                                            <span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="s2">&quot;A_seq&quot;</span><span class="p">,</span><span class="s2">&quot;A_id_num&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">new_bump_wait</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;A_seq&quot;</span>   <span class="p">:</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">,</span>
                                          <span class="s2">&quot;A_id_num&quot;</span><span class="p">:</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID_NUM</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># need trip id num</span>
            <span class="n">new_bump_wait</span> <span class="o">=</span> <span class="n">trips</span><span class="o">.</span><span class="n">add_numeric_trip_id</span><span class="p">(</span><span class="n">new_bump_wait</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span> <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;new_bump_wait (</span><span class="si">%d</span><span class="s2"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_bump_wait</span><span class="p">),</span> <span class="n">new_bump_wait</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

             <span class="c1"># incorporate it into the bump wait df</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span> <span class="o">=</span> <span class="n">new_bump_wait</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">,</span> <span class="n">new_bump_wait</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load_passengers_on_vehicles_with_cap() bump_wait_df (</span><span class="si">%d</span><span class="s2"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">),</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

                <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID_NUM</span><span class="p">,</span>
                                                                <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_SEQUENCE</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># finally, incorporate the board state and bump_iter to the full pathset_links_df</span>
            <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>   <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
                                            <span class="n">right</span>  <span class="o">=</span><span class="n">bumpstop_boards</span><span class="p">[[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">,</span>
                                                                     <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">,</span>
                                                                     <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]],</span>
                                            <span class="n">on</span>     <span class="o">=</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">,</span>
                                                     <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_NUM</span><span class="p">],</span>
                                            <span class="n">how</span>    <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                            <span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot; bb&quot;</span><span class="p">],</span>
                                            <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> bb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> bb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span>  <span class="p">]</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> bb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> bb&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">pax_links_debug_columns</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

            <span class="c1"># bump the whole path</span>
            <span class="n">bump_paths_df</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span><span class="p">]</span><span class="o">==</span><span class="n">bump_iter</span><span class="p">,</span>
                                                 <span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_ID</span><span class="p">,</span>
                                                  <span class="n">Passenger</span><span class="o">.</span><span class="n">TRIP_LIST_COLUMN_PERSON_TRIP_ID</span><span class="p">,</span>
                                                  <span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PATH_NUM</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">pathset_paths_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">pathset_paths_df</span><span class="p">,</span>
                                            <span class="n">right</span>    <span class="o">=</span><span class="n">bump_paths_df</span><span class="p">,</span>
                                            <span class="n">how</span>      <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                            <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_paths_df</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span> <span class="p">]</span> <span class="o">=</span> <span class="n">bump_iter</span>
            <span class="n">pathset_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># communicate back to other links in the same path too</span>
            <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">pathset_links_df</span><span class="p">,</span>
                                            <span class="n">right</span>    <span class="o">=</span><span class="n">bump_paths_df</span><span class="p">,</span>
                                            <span class="n">how</span>      <span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                            <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BUMP_ITER</span> <span class="p">]</span> <span class="o">=</span> <span class="n">bump_iter</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;both&quot;</span><span class="p">)</span><span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">|</span>
                                   <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;boarded&quot;</span><span class="p">)</span><span class="o">|</span>
                                   <span class="p">(</span><span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;board_easy&quot;</span><span class="p">))</span><span class="o">&amp;</span>
                                  <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_ROUTE_ID</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_BOARD_STATE</span> <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bumped_othertrip&quot;</span>
            <span class="n">pathset_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_merge&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;        -&gt; completed loop bump_iter </span><span class="si">%d</span><span class="s2"> and bumped </span><span class="si">%d</span><span class="s2"> chosen paths&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bump_iter</span><span class="p">,</span> <span class="n">chosen_paths_bumped</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">chosen_paths_bumped</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">bump_iter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME_MIN</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mf">60.0</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">minute</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">second</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Bump_wait_df:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_loaded_df</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">choose_paths_without_simulation</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a pathset for each passernger, choose a path (if relevant).  That&#39;s it.</span>

<span class="sd">        Returns (valid_linked_trips, pathset_paths_df, pathset_links_df)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulation_iteration</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_passengers_arrived</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">######################################################################################################</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 1. Find out board/alight times for all pathset links from vehicle times&quot;</span><span class="p">)</span>

        <span class="c1"># could do this just to chosen path links but let&#39;s do this to the whole pathset</span>
        <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_passenger_vehicle_times</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

        <span class="c1"># instead of flag_missed_transfers(), set these to pathfinding results</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_ALIGHT_DELAY_MIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_A_TIME</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_A_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_B_TIME</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_PAX_B_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_LINK_TIME</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_LINK_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_WAIT_TIME</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Passenger</span><span class="o">.</span><span class="n">PF_COL_WAIT_TIME</span><span class="p">]</span>
        <span class="n">pathset_links_df</span><span class="p">[</span><span class="n">Assignment</span><span class="o">.</span><span class="n">SIM_COL_PAX_MISSED_XFER</span>     <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">######################################################################################################</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 2. Calculate costs and probabilities for all pathset paths&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">veh_trips_df</span><span class="p">,</span>
            <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">tazs</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">transfers</span><span class="p">,</span> <span class="n">stops</span><span class="o">=</span><span class="n">FT</span><span class="o">.</span><span class="n">stops</span><span class="p">,</span>
            <span class="n">reset_bump_iter</span><span class="o">=</span><span class="n">simulation_iteration</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">######################################################################################################</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 3. Choose a path for each passenger from their pathset&quot;</span><span class="p">)</span>

        <span class="c1"># Choose path for each passenger -- pathset_paths_df and pathset_links_df will now have</span>
        <span class="c1"># SIM_COL_PAX_CHOSEN &gt;=0 for chosen paths/path links</span>
        <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">num_chosen</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">choose_paths</span><span class="p">(</span>
            <span class="kc">True</span><span class="p">,</span>  <span class="c1"># choose for everyone</span>
            <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span>
            <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>

        <span class="c1"># Write the pathsets</span>
        <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>  <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>

        <span class="c1"># write the final chosen paths for this iteration</span>
        <span class="n">chosen_links_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">)</span>
        <span class="n">chosen_links_df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">chosen_links_df</span><span class="p">,</span> <span class="s2">&quot;chosen_links_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;chosenpaths_links.csv&quot;</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="p">(</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">),</span>
                             <span class="n">drop_debug_columns</span>      <span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span>
                             <span class="n">drop_pathfinding_columns</span><span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">chosen_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">chosen_paths_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">)</span>
        <span class="n">chosen_paths_df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">chosen_paths_df</span><span class="p">,</span> <span class="s2">&quot;chosen_paths_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;chosenpaths_paths.csv&quot;</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="p">(</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">),</span>
                             <span class="n">drop_debug_columns</span>      <span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span>
                             <span class="n">drop_pathfinding_columns</span><span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">chosen_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a pathset for each passenger, choose a path (if relevant) and then</span>
<span class="sd">        actually assign the passengers trips to the vehicles.</span>

<span class="sd">        Returns (valid_linked_trips, pathset_paths_df, pathset_links_df, veh_loaded_df)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulation_iteration</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_passengers_arrived</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># will get returned from choose_paths</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_start</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="s2">&quot;simulation iteration&quot;</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Simulation Iteration </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">simulation_iteration</span><span class="p">)</span>
            <span class="c1"># for trace_tuple in Assignment.TRACE_PERSON_IDS:</span>
            <span class="c1">#     FastTripsLogger.debug(&quot;Initial pathset_links_df for %s\n%s&quot; % \</span>
            <span class="c1">#        (str(trace_pax), pathset_links_df.loc[pathset_links_df.person_id==trace_pax].to_string()))</span>
            <span class="c1">#     FastTripsLogger.debug(&quot;Initial pathset_paths_df for %s\n%s&quot; % \</span>
            <span class="c1">#        (str(trace_pax), pathset_paths_df.loc[pathset_paths_df.person_id==trace_pax].to_string()))</span>

            <span class="c1">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 1. Find out board/alight times for all pathset links from vehicle times&quot;</span><span class="p">)</span>

            <span class="c1"># could do this just to chosen path links but let&#39;s do this to the whole pathset</span>
            <span class="n">pathset_links_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_passenger_vehicle_times</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

            <span class="c1">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 2. Flag missed transfer links and paths in the pathsets&quot;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">flag_missed_transfers</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>

            <span class="c1">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 3. Calculate costs and probabilities for all pathset paths&quot;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">PathSet</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">STOCH_DISPERSION</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">,</span>
                <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">trip_list_df</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">tazs</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">transfers</span><span class="p">,</span> <span class="n">stops</span><span class="o">=</span><span class="n">FT</span><span class="o">.</span><span class="n">stops</span><span class="p">,</span>
                <span class="n">reset_bump_iter</span><span class="o">=</span><span class="n">simulation_iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 4. Choose a path for each passenger from their pathset&quot;</span><span class="p">)</span>

            <span class="c1"># Choose path for each passenger -- pathset_paths_df and pathset_links_df will now have</span>
            <span class="c1"># SIM_COL_PAX_CHOSEN &gt;=0 for chosen paths/path links</span>
            <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">num_chosen</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">choose_paths</span><span class="p">(</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">PATHFINDING_EVERYONE</span> <span class="ow">and</span> <span class="n">simulation_iteration</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># choose for everyone if we just re-found all paths</span>
                <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span>
                <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">)</span>

            <span class="c1">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 5. Put passenger paths on transit vehicles to get vehicle boards/alights/load and assess capacity constraints&quot;</span><span class="p">)</span>

            <span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">load_passengers_on_vehicles_with_cap</span><span class="p">(</span>
                <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span>
                <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

            <span class="c1">######################################################################################################</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 6. Update dwell and travel times for transit vehicles&quot;</span><span class="p">)</span>
            <span class="c1"># update the trip times -- accel/decel rates + stops affect travel times, and boards/alights affect dwell times</span>
            <span class="n">veh_trips_df</span>   <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">update_trip_times</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MSA_RESULTS</span><span class="p">)</span>

            <span class="c1">######################################################################################################</span>
            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Step 7. Write pathsets (paths and links)&quot;</span><span class="p">)</span>
                <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
                <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
                <span class="c1"># and vehicle trips</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">write_vehicle_trips</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>


            <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_end</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">)</span>
            <span class="n">simulation_iteration</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">num_chosen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  No more path choices to make =&gt; Ending simulation loop&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">simulation_iteration</span> <span class="o">&gt;</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_SIMULATION_ITERS</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Maximum simulation iterations reached (</span><span class="si">%d</span><span class="s2">) =&gt; Ending simulation loop&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">MAX_SIMULATION_ITERS</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_start</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="s2">&quot;output_per_simulation&quot;</span><span class="p">)</span>

        <span class="c1"># Write the pathsets (if we haven&#39;t been already)</span>
        <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
            <span class="n">Passenger</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PATHSET_PER_SIM_ITER</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>

        <span class="c1"># write the final chosen paths for this iteration</span>
        <span class="n">chosen_links_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_links_df</span><span class="p">)</span>
        <span class="n">chosen_links_df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">chosen_links_df</span><span class="p">[</span><span class="s2">&quot;pathfinding_iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathfinding_iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">chosen_links_df</span><span class="p">,</span> <span class="s2">&quot;chosen_links_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;chosenpaths_links.csv&quot;</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="p">((</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pathfinding_iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)),</span>
                             <span class="n">drop_debug_columns</span>      <span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span>
                             <span class="n">drop_pathfinding_columns</span><span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">chosen_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;iteration&quot;</span><span class="p">,</span> <span class="s2">&quot;pathfinding_iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">chosen_paths_df</span> <span class="o">=</span> <span class="n">Passenger</span><span class="o">.</span><span class="n">get_chosen_links</span><span class="p">(</span><span class="n">pathset_paths_df</span><span class="p">)</span>

        <span class="n">chosen_paths_df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span>            <span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">chosen_paths_df</span><span class="p">[</span><span class="s2">&quot;pathfinding_iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathfinding_iteration</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">chosen_paths_df</span><span class="p">,</span> <span class="s2">&quot;chosen_paths_df&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;chosenpaths_paths.csv&quot;</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="p">((</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pathfinding_iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)),</span>
                             <span class="n">drop_debug_columns</span>      <span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">,</span>
                             <span class="n">drop_pathfinding_columns</span><span class="o">=</span><span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">DEBUG_OUTPUT_COLUMNS</span><span class="p">)</span>
        <span class="n">chosen_paths_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;iteration&quot;</span><span class="p">,</span> <span class="s2">&quot;pathfinding_iteration&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">FT</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_step_end</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">simulation_iteration</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span> <span class="n">pathset_paths_df</span><span class="p">,</span> <span class="n">pathset_links_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">find_trip_based_paths_process_worker</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">worker_num</span><span class="p">,</span> <span class="n">input_network_dir</span><span class="p">,</span> <span class="n">input_demand_dir</span><span class="p">,</span> <span class="n">run_config</span><span class="p">,</span> <span class="n">func_file</span><span class="p">,</span>
                                         <span class="n">output_dir</span><span class="p">,</span> <span class="n">todo_pathset_queue</span><span class="p">,</span> <span class="n">done_queue</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">bump_wait_df</span><span class="p">,</span> <span class="n">stop_times_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process worker function.  Processes all the paths in queue.</span>

<span class="sd">    todo_queue has (passenger_id, path object)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker_str</span> <span class="o">=</span> <span class="s2">&quot;_worker</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">worker_num</span>

    <span class="kn">from</span> <span class="nn">.FastTrips</span> <span class="kn">import</span> <span class="n">FastTrips</span>
    <span class="n">setupLogging</span><span class="p">(</span><span class="n">infoLogFilename</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">debugLogFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">FastTrips</span><span class="o">.</span><span class="n">DEBUG_LOG</span> <span class="o">%</span> <span class="n">worker_str</span><span class="p">),</span>
                 <span class="n">logToConsole</span>     <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">append</span>           <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">((</span><span class="n">iteration</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pathfinding_iteration</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Iteration </span><span class="si">%d</span><span class="s2"> Pathfinding Iteration </span><span class="si">%d</span><span class="s2"> Worker </span><span class="si">%2d</span><span class="s2"> starting&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">worker_num</span><span class="p">))</span>

    <span class="c1"># the child process doesn&#39;t have these set so read them</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FILE</span>           <span class="o">=</span> <span class="n">run_config</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">CONFIGURATION_FUNCTIONS_FILE</span> <span class="o">=</span> <span class="n">func_file</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">read_functions</span><span class="p">(</span><span class="n">func_file</span><span class="p">)</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">read_configuration</span><span class="p">(</span><span class="n">run_config</span><span class="p">)</span>

    <span class="c1"># this passes those read parameters and the stop times to the C++ extension</span>
    <span class="n">Assignment</span><span class="o">.</span><span class="n">initialize_fasttrips_extension</span><span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">stop_times_df</span><span class="p">)</span>

    <span class="c1"># the extension has it now, so we&#39;re done</span>
    <span class="n">stop_times_df</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">set_fasttrips_bump_wait</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># go through my queue -- check if we&#39;re done</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="n">todo_pathset_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">todo</span> <span class="o">==</span> <span class="s1">&#39;DONE&#39;</span><span class="p">:</span>
            <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="s1">&#39;DONE&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received DONE from the todo_pathset_queue&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># do the work</span>
        <span class="n">pathset</span> <span class="o">=</span> <span class="n">todo</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing person </span><span class="si">%20s</span><span class="s2"> trip </span><span class="si">%20s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">))</span>
        <span class="c1"># communicate it to the parent</span>
        <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="s2">&quot;STARTING&quot;</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span> <span class="p">))</span>

        <span class="n">trace_person</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_IDS</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tracing assignment of person </span><span class="si">%s</span><span class="s2"> trip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathset</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">person_trip_id</span><span class="p">))</span>
            <span class="n">trace_person</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">pathdict</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_trip_based_pathset</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">pathfinding_iteration</span><span class="p">,</span> <span class="n">pathset</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">trace_person</span><span class="p">)</span>
            <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="s2">&quot;COMPLETED&quot;</span><span class="p">,</span> <span class="n">pathset</span><span class="o">.</span><span class="n">trip_list_id_num</span><span class="p">,</span> <span class="n">pathdict</span><span class="p">,</span> <span class="n">perf_dict</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception&quot;</span><span class="p">)</span>
            <span class="c1"># call it a day</span>
            <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="s2">&quot;EXCEPTION&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2015-2018, Lisa Zorn.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>